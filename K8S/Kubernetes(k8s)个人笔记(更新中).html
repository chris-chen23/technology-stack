<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
   
  <meta name="keywords" content="程序猿" />
   
  <meta name="description" content="好好学习，天天向上" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    Kubernetes(k8s)个人学习笔记(更新中) |  wangzichen的个人博客
  </title>
  <meta name="generator" content="hexo-theme-yilia-plus">
  
  <link rel="shortcut icon" href="/images/favicon.ico" />
  
  <link rel="stylesheet" href="/css/main.css">
  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

  

</head>

</html>

<body>
  <div id="app">
    <main class="content">
      <section class="outer">
  <article id="post-Kubernetes(k8s)个人笔记(更新中)" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Kubernetes(k8s)个人学习笔记(更新中)
</h1>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/04/12/Kubernetes(k8s)个人笔记(更新中)/" class="article-date">
  <time datetime="2020-04-12T15:05:43.000Z" itemprop="datePublished">2020-04-12</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/虚拟化/">虚拟化</a>
  </div>

      
      
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">6.6k字</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">33分钟</span>
        </span>
    </span>
</div>

      
    </div>
    

    
    
    <div class="tocbot"></div>





    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h2 id="Kubernetes-k8s-个人笔记💪"><a href="#Kubernetes-k8s-个人笔记💪" class="headerlink" title="Kubernetes(k8s)个人笔记💪"></a>Kubernetes(k8s)个人笔记💪</h2><h3 id="一、概念"><a href="#一、概念" class="headerlink" title="一、概念"></a>一、概念</h3><h4 id="什么是k8s"><a href="#什么是k8s" class="headerlink" title="什么是k8s?"></a>什么是k8s?</h4><ul>
<li>k8s是一组服务器集群</li>
<li>K8s所管理的集群节点上的容器</li>
</ul>
<h4 id="k8s的功能"><a href="#k8s的功能" class="headerlink" title="k8s的功能"></a>k8s的功能</h4><ul>
<li>自我修复</li>
<li>弹性伸缩：实时根据服务器并发情况，增加或者缩减容器数量</li>
<li>自动部署</li>
<li>回滚</li>
<li>服务发现和负载均衡</li>
<li>机密和配置共享管理</li>
</ul>
<a id="more"></a>

<h4 id="k8s集群分为两类节点"><a href="#k8s集群分为两类节点" class="headerlink" title="k8s集群分为两类节点"></a>k8s集群分为两类节点</h4><ul>
<li>master node：主</li>
<li>worker node：工作</li>
</ul>
<h4 id="master节点组件"><a href="#master节点组件" class="headerlink" title="master节点组件"></a>master节点组件</h4><ul>
<li>apiserver：接收客户端操作k8s的指令</li>
<li>schduler：从多个worker node节点的组件中选举一个来启动服务</li>
<li>controller manager：向worker节点的kubelet发送指令</li>
</ul>
<h4 id="workder-node节点组件"><a href="#workder-node节点组件" class="headerlink" title="workder node节点组件"></a>workder node节点组件</h4><ul>
<li>kubelet：向docker发送指令管理docker容器的</li>
<li>kube-proxy：管理docker容器的网络</li>
</ul>
<img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s-2.png">

<img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s-3.png">

<img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s-4.png">

<h4 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h4><p>k8s的数据库，用来注册节点、服务、记录账户信息……</p>
<p><font color="red">运行流程图</font><br><img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s-1.png"></p>
<h3 id="二、核心概念"><a href="#二、核心概念" class="headerlink" title="二、核心概念"></a>二、核心概念</h3><h4 id="pod"><a href="#pod" class="headerlink" title="pod"></a>pod</h4><ul>
<li>pod是k8s最小的部署单元</li>
<li>一个pod中可以有一个或者多个容器（一组容器的集合，即容器组）</li>
<li>一个pod中的容器共享网络命名空间</li>
<li>pod是短暂的</li>
</ul>
<h4 id="controllers：控制器，用来控制pod，启动、停止、删除"><a href="#controllers：控制器，用来控制pod，启动、停止、删除" class="headerlink" title="controllers：控制器，用来控制pod，启动、停止、删除"></a>controllers：控制器，用来控制pod，启动、停止、删除</h4><ul>
<li>ReplicaSet：确保预期的pod副本数量</li>
<li>Deployment：无状态应用部署（用的多）</li>
<li>StatefulSet：有状态应用部署</li>
<li>DaemonSet：确保所有Node运行同一个Pod</li>
<li>Job：一次性任务</li>
<li>Cronjob：定时任务</li>
</ul>
<h4 id="Service：服务"><a href="#Service：服务" class="headerlink" title="Service：服务"></a>Service：服务</h4><p>将一组pod关联起来，提供一个统一的入口，即使pod的网络地址发生改变，这个统一入口也不会改变</p>
<ul>
<li>防止pod失联</li>
<li>定义一组pod的访问策略</li>
</ul>
<h4 id="Label：标签"><a href="#Label：标签" class="headerlink" title="Label：标签"></a>Label：标签</h4><p>一组pod有一个统一的标签，service通过标签和一组pod进行关联</p>
<h4 id="NameSpace：命名空间"><a href="#NameSpace：命名空间" class="headerlink" title="NameSpace：命名空间"></a>NameSpace：命名空间</h4><p>用来隔离pod的运行环境【默认情况下，pod是可以互相访问的】</p>
<p>使用场景：</p>
<ul>
<li>为不同的公司提供隔离的pod运行环境</li>
<li>为开发环境、测试环境、生产环境分别准备不同的名称空间，进行隔离</li>
</ul>
<h4 id="个人补充（看到有意义的就会写）"><a href="#个人补充（看到有意义的就会写）" class="headerlink" title="个人补充（看到有意义的就会写）"></a>个人补充（看到有意义的就会写）</h4><ol>
<li><p><font color="green"><strong>Kubernetes里的3种IP</strong></font></p>
<ul>
<li>Node IP：Node的ip地址。Node IP是Kubernetes集群中每个节点的物理网卡的IP地址，是一个真实存在的物理网络，所有属于这个网络的服务器都能通过这个网络直接通信，不管其中是否有部分节点不属于这个Kubernetes集群。这也表明在Kubernetes集群之外的节点访问Kubernetes集群之内的某个节点或者TCP/IP服务时，都必须通过NodeIP通信。</li>
<li>Pod IP：Pod的ip地址。Pod IP是每个Pod的IP地址，它是Docker Engine根据docker0网桥的IP地址段进行分配的，通常是一个虚拟的二层网络，前面说过，Kubernetes要求位于不同Node上的Pod都能够彼此直接通信，所以Kubernetes里一个Pod里的容器访问另外一个Pod里的容器时，就是通过Pod IP所在的虚拟二层网络进行通信的，而真实的TCP/IP流量是通过Node IP所在的物理网卡流出的。</li>
<li>Cluster IP：Service的ip地址。Cluster IP仅仅作用于Kubernetes Service这个对象，并由Kubernetes管理和分配IP地址；Cluster IP无法被Ping，因为没有一个“实体网络对象”来响应；Cluster IP只能结合Service Port组成一个具体的通信端口，单独的Cluster IP不具备TCP/IP通信的基础，并且它们属于Kubernetes集群这样一个封闭的空间，集群外的节点如果要访问这个通信端口，则需要做一些额外的工作。</li>
</ul>
</li>
</ol>
<h3 id="三、搭建一个完整的k8s集群（离线部署）"><a href="#三、搭建一个完整的k8s集群（离线部署）" class="headerlink" title="三、搭建一个完整的k8s集群（离线部署）"></a>三、搭建一个完整的k8s集群（离线部署）</h3><img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s-5.png">

<h4 id="单master集群"><a href="#单master集群" class="headerlink" title="单master集群"></a>单master集群</h4><img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s-6.png">

<h4 id="多master集群（HA高可用）——生产环境"><a href="#多master集群（HA高可用）——生产环境" class="headerlink" title="多master集群（HA高可用）——生产环境"></a>多master集群（HA高可用）——生产环境</h4><img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s-7.png">

<h4 id="推荐配置"><a href="#推荐配置" class="headerlink" title="推荐配置"></a>推荐配置</h4><img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s-8.png">

<h3 id="四、初始化服务器"><a href="#四、初始化服务器" class="headerlink" title="四、初始化服务器"></a>四、初始化服务器</h3><table>
<thead>
<tr>
<th align="center">角色</th>
<th align="center">IP</th>
<th align="center">组件</th>
</tr>
</thead>
<tbody><tr>
<td align="center">k8s_master1</td>
<td align="center">192.168.18.80</td>
<td align="center">kube-apiserver,kube-controller-manager,kube-scheduler,etcd</td>
</tr>
<tr>
<td align="center">k8s_node1</td>
<td align="center">192.168.18.85</td>
<td align="center">kubelet,kube-proxy,docker,flannel,etcd</td>
</tr>
<tr>
<td align="center">k8s_node2</td>
<td align="center">192.168.18.86</td>
<td align="center">kubelet,kube-proxy,docker,flannel,etcd</td>
</tr>
</tbody></table>
<ul>
<li><p>关闭防火墙</p>
<ul>
<li>systemctl stop firewalld</li>
<li>systemctl disable firewalld</li>
</ul>
</li>
<li><p>关闭selinux</p>
<ul>
<li>临时关闭setenforce 0</li>
<li>vi /etc/selinux/config修改SELINUX=disabled</li>
</ul>
</li>
<li><p>配置主机名</p>
<ul>
<li>vi /etc/hostname</li>
</ul>
</li>
<li><p>配置名称解析</p>
<ul>
<li>vi /etc/hosts修改ip+主机名（如192.168.18.110 docker）</li>
</ul>
</li>
<li><p>关闭交换分区</p>
<ul>
<li>临时关闭swapoff -a</li>
<li>vi /etc/fstab 删除最后一行swap</li>
<li>检查：free -m</li>
</ul>
</li>
<li><p>配置时间同步</p>
<ul>
<li>服务端<ul>
<li>yum install chrony -y</li>
<li>vi /etc/chrony.conf</li>
<li>server ntp.sjtu.edu.cn</li>
<li>allow 192.168.18.0/24</li>
<li>local stratum 10</li>
<li>启动服务端<ul>
<li>systemctl start chronyd</li>
<li>systemctl enable chronyd</li>
</ul>
</li>
</ul>
</li>
<li>客户端<ul>
<li>vi /etc/chrony.conf</li>
<li>server 202.120.2.101 iburst</li>
<li>启动客户端<ul>
<li>systemctl start chronyd</li>
<li>systemctl enable chronyd</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="五、部署etcd"><a href="#五、部署etcd" class="headerlink" title="五、部署etcd"></a>五、部署etcd</h3><h4 id="给etcd颁发证书"><a href="#给etcd颁发证书" class="headerlink" title="给etcd颁发证书"></a>给etcd颁发证书</h4><ul>
<li>创建证书颁发机构</li>
<li>填写表单–写明etcd所在节点的ip</li>
<li>向证书颁发机构申请证书</li>
</ul>
<h4 id="下载cfssl工具"><a href="#下载cfssl工具" class="headerlink" title="下载cfssl工具"></a>下载cfssl工具</h4><p>(在/home/etcd下)使用cfssl来生成自签证书，先下载cfssl工具：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line"><span class="meta">#</span> wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line"><span class="meta">#</span> wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line"><span class="meta">#</span> chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span><br><span class="line"><span class="meta">#</span> mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line"><span class="meta">#</span> mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line"><span class="meta">#</span> mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</span><br></pre></td></tr></table></figure>

<h4 id="生成证书-编写三个json文件"><a href="#生成证书-编写三个json文件" class="headerlink" title="生成证书:编写三个json文件"></a>生成证书:编写三个json文件</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 我的位置在/home/etcd下，三个json文件创建</span></span><br><span class="line"><span class="comment"># cat ca-config.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">  "signing":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "default":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">      "expiry":</span> <span class="string">"87600h"</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">    "profiles":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">      "www":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">         "expiry":</span> <span class="string">"87600h"</span><span class="string">,</span></span><br><span class="line"><span class="attr">         "usages":</span> <span class="string">[</span></span><br><span class="line">            <span class="string">"signing"</span><span class="string">,</span></span><br><span class="line">            <span class="string">"key encipherment"</span><span class="string">,</span></span><br><span class="line">            <span class="string">"server auth"</span><span class="string">,</span></span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        <span class="string">]</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat ca-csr.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "CN":</span> <span class="string">"etcd CA"</span><span class="string">,</span></span><br><span class="line"><span class="attr">    "key":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">        "algo":</span> <span class="string">"rsa"</span><span class="string">,</span></span><br><span class="line"><span class="attr">        "size":</span> <span class="number">2048</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">    "names":</span> <span class="string">[</span></span><br><span class="line">        <span class="string">&#123;</span></span><br><span class="line"><span class="attr">            "C":</span> <span class="string">"CN"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "L":</span> <span class="string">"Beijing"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "ST":</span> <span class="string">"Beijing"</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat server-csr.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "CN":</span> <span class="string">"etcd"</span><span class="string">,</span></span><br><span class="line"><span class="attr">    "hosts":</span> <span class="string">[</span></span><br><span class="line">    <span class="string">"192.168.18.80"</span><span class="string">,</span></span><br><span class="line">    <span class="string">"192.168.18.85"</span><span class="string">,</span></span><br><span class="line">    <span class="string">"192.168.18.86"</span></span><br><span class="line">    <span class="string">],</span></span><br><span class="line"><span class="attr">    "key":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">        "algo":</span> <span class="string">"rsa"</span><span class="string">,</span></span><br><span class="line"><span class="attr">        "size":</span> <span class="number">2048</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">    "names":</span> <span class="string">[</span></span><br><span class="line">        <span class="string">&#123;</span></span><br><span class="line"><span class="attr">            "C":</span> <span class="string">"CN"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "L":</span> <span class="string">"BeiJing"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "ST":</span> <span class="string">"BeiJing"</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">]</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>生成证书命令行</span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server</span><br><span class="line"><span class="meta">#</span> ls *pem（应该有4个pem结尾的文件）</span><br><span class="line">ca-key.pem  ca.pem  server-key.pem  server.pem</span><br></pre></td></tr></table></figure>

<h4 id="部署etcd"><a href="#部署etcd" class="headerlink" title="部署etcd"></a>部署etcd</h4><p>这里使用的是二进制部署，不想用其他的方法。</p>
<p>二进制包下载地址：<a href="https://github.com/coreos/etcd/releases/" target="_blank" rel="noopener">https://github.com/coreos/etcd/releases/</a></p>
<p><strong>有etcd的node上都要部署，注意文件夹的名字和位置，不是随便命名和放置的</strong>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>解压压缩包</span><br><span class="line">mkdir /opt/etcd/&#123;bin,cfg,ssl&#125; -p</span><br><span class="line">tar -zxvf etcd-v3.2.12-linux-amd64.tar.gz -C ./</span><br><span class="line">mv etcd-v3.2.12-linux-amd64/&#123;etcd,etcdctl&#125; /opt/etcd/bin/</span><br></pre></td></tr></table></figure>

<p><font color="orange">创建etcd配置文件</font></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># touch etcd</span></span><br><span class="line"><span class="comment"># chmod 777 etcd</span></span><br><span class="line"><span class="comment"># cat /opt/etcd/cfg/etcd   </span></span><br><span class="line"><span class="comment">#[Member]</span></span><br><span class="line"><span class="string">ETCD_NAME="k8s_master1"</span></span><br><span class="line"><span class="string">ETCD_DATA_DIR="/var/lib/etcd/default.etcd"</span></span><br><span class="line"><span class="string">ETCD_LISTEN_PEER_URLS="https://192.168.18.80:2380"</span></span><br><span class="line"><span class="string">ETCD_LISTEN_CLIENT_URLS="https://192.168.18.80:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line"><span class="string">ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.18.80:2380"</span></span><br><span class="line"><span class="string">ETCD_ADVERTISE_CLIENT_URLS="https://192.168.18.80:2379"</span></span><br><span class="line"><span class="string">ETCD_INITIAL_CLUSTER="etcd01=https://192.168.18.80:2380,k8s_node1=https://192.168.18.85:2380,k8s_node2=https://192.168.18.86:2380"</span></span><br><span class="line"><span class="string">ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"</span></span><br><span class="line"><span class="string">ETCD_INITIAL_CLUSTER_STATE="new"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------------------解释-------------------------------------------</span></span><br><span class="line"><span class="comment">#ETCD_NAME 节点名称</span></span><br><span class="line"><span class="comment">#ETCD_DATA_DIR 数据目录</span></span><br><span class="line"><span class="comment">#ETCD_LISTEN_PEER_URLS 集群通信监听地址</span></span><br><span class="line"><span class="comment">#ETCD_LISTEN_CLIENT_URLS 客户端访问监听地址</span></span><br><span class="line"><span class="comment">#ETCD_INITIAL_ADVERTISE_PEER_URLS 集群通告地址</span></span><br><span class="line"><span class="comment">#ETCD_ADVERTISE_CLIENT_URLS 客户端通告地址</span></span><br><span class="line"><span class="comment">#ETCD_INITIAL_CLUSTER 集群节点地址</span></span><br><span class="line"><span class="comment">#ETCD_INITIAL_CLUSTER_TOKEN 集群Token</span></span><br><span class="line"><span class="comment">#ETCD_INITIAL_CLUSTER_STATE 加入集群的当前状态，new是新集群，existing表示加入已有集群</span></span><br></pre></td></tr></table></figure>

<p><font color="orange">systemd管理etcd</font></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># touch /usr/lib/systemd/system/etcd.service</span></span><br><span class="line"><span class="comment"># cat /usr/lib/systemd/system/etcd.service </span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Etcd</span> <span class="string">Server</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string">After=network-online.target</span></span><br><span class="line"><span class="string">Wants=network-online.target</span></span><br><span class="line"></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">EnvironmentFile=/opt/etcd/cfg/etcd</span></span><br><span class="line"><span class="string">ExecStart=/opt/etcd/bin/etcd</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-name=$&#123;ETCD_NAME&#125;</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-data-dir=$&#123;ETCD_DATA_DIR&#125;</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-listen-peer-urls=$&#123;ETCD_LISTEN_PEER_URLS&#125;</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-listen-client-urls=$&#123;ETCD_LISTEN_CLIENT_URLS&#125;,http://127.0.0.1:2379</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-advertise-client-urls=$&#123;ETCD_ADVERTISE_CLIENT_URLS&#125;</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-initial-advertise-peer-urls=$&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125;</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-initial-cluster=$&#123;ETCD_INITIAL_CLUSTER&#125;</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-initial-cluster-token=$&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125;</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-initial-cluster-state=new</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-cert-file=/opt/etcd/ssl/server.pem</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-key-file=/opt/etcd/ssl/server-key.pem</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-peer-cert-file=/opt/etcd/ssl/server.pem</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-peer-key-file=/opt/etcd/ssl/server-key.pem</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-trusted-ca-file=/opt/etcd/ssl/ca.pem</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-peer-trusted-ca-file=/opt/etcd/ssl/ca.pem</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">LimitNOFILE=65536</span></span><br><span class="line"></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br></pre></td></tr></table></figure>

<p><font color="orange">将之前生成的证书拷贝到固定的目录</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ca*pem server*pem /opt/etcd/ssl</span><br></pre></td></tr></table></figure>

<p><font color="orange">启动并设置开机启动</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start etcd</span><br><span class="line">systemctl enable etcd</span><br></pre></td></tr></table></figure>

<p><font color="red">注意：以上步骤需要在所有要安装etcd的node上执行一次，不是只在master node上执行，可以通过scp命令发送到其他node，需要改一下etcd的配置文件，节点名和节点ip。</font></p>
<p><font color="orange">在都部署完成后，检查一下集群的状态(若是出现cluster is healthy，说明部署成功！)</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s_master1 cfg]# /opt/etcd/bin/etcdctl --ca-file=/opt/etcd/ssl/ca.pem --cert-file=/opt/etcd/ssl/server.pem --key-file=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.18.80:2379,https://192.168.18.85:2379,https://192.168.18.86:2379&quot; cluster-health</span><br><span class="line">member feb9f9de26a0d6d is healthy: got healthy result from https://192.168.18.80:2379</span><br><span class="line">member 94c59c0ee7401835 is healthy: got healthy result from https://192.168.18.85:2379</span><br><span class="line">member a5106f019eb73cbd is healthy: got healthy result from https://192.168.18.86:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure>

<h3 id="六、安装docker"><a href="#六、安装docker" class="headerlink" title="六、安装docker"></a>六、安装docker</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"># wget -O CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"># yum install docker-ce -y</span><br><span class="line"># systemctl start docker</span><br><span class="line"># systemctl enable docker</span><br></pre></td></tr></table></figure>

<h3 id="七、部署Flannel网络"><a href="#七、部署Flannel网络" class="headerlink" title="七、部署Flannel网络"></a>七、部署Flannel网络</h3><p><strong>工作原理：</strong></p>
<img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/flannel.png">

<p><strong>Flannel要用etcd存储自身一个子网信息，要保证能成功连接etcd，写入预定义子网段</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#------------------注意：这里没有在master节点上部署flannel--------------------</span><br><span class="line"># /opt/etcd/bin/etcdctl \</span><br><span class="line">--ca-file=ca.pem --cert-file=server.pem --key-file=server-key.pem \</span><br><span class="line">--endpoints=&quot;https://192.168.18.85:2379,https://192.168.18.86:2379&quot; \</span><br><span class="line">set /coreos.com/network/config  &apos;&#123; &quot;Network&quot;: &quot;172.17.76.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;&apos;</span><br><span class="line"></span><br><span class="line">#-------------------------------------------------------------------------</span><br><span class="line">#设置完成后可以通过以下查看</span><br><span class="line"># /opt/etcd/bin/etcdctl \</span><br><span class="line">--ca-file=ca.pem --cert-file=server.pem --key-file=server-key.pem \</span><br><span class="line">--endpoints=&quot;https://192.168.18.85:2379,https://192.168.18.86:2379&quot; \</span><br><span class="line">get /coreos.com/network/config</span><br></pre></td></tr></table></figure>

<p><strong>以下的步骤需要在每个部署flannel的节点上操作</strong></p>
<p><font color="orange">下载二进制包</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># wget https://github.com/coreos/flannel/releases/download/v0.10.0/flannel-v0.10.0-linux-amd64.tar.gz</span><br><span class="line"># tar -zxvf flannel-v0.9.1-linux-amd64.tar.gz -C ./</span><br><span class="line"># mv flanneld mk-docker-opts.sh /opt/kubernetes/bin</span><br></pre></td></tr></table></figure>

<p><font color="orange">配置Flannel</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cat /opt/kubernetes/cfg/flanneld</span><br><span class="line">FLANNEL_OPTIONS=&quot;--etcd-endpoints=https://192.168.18.85:2379,https://192.168.18.86:2379 -etcd-cafile=/opt/etcd/ssl/ca.pem -etcd-certfile=/opt/etcd/ssl/server.pem -etcd-keyfile=/opt/etcd/ssl/server-key.pem&quot;</span><br></pre></td></tr></table></figure>

<p><font color="orange">systemd管理Flannel</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># cat /usr/lib/systemd/system/flanneld.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network-online.target network.target</span><br><span class="line">Before=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/flanneld</span><br><span class="line">ExecStart=/opt/kubernetes/bin/flanneld --ip-masq $FLANNEL_OPTIONS</span><br><span class="line">ExecStartPost=/opt/kubernetes/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/subnet.env</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><font color="orange">配置Docker启动指定子网段</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># cat /usr/lib/systemd/system/docker.service </span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/run/flannel/subnet.env</span><br><span class="line">ExecStart=/usr/bin/dockerd $DOCKER_NETWORK_OPTIONS</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><font color="orange">重启Flannel和Docker</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># systemctl daemon-reload</span><br><span class="line"># systemctl start flanneld</span><br><span class="line"># systemctl enable flanneld</span><br><span class="line"># systemctl restart docker</span><br></pre></td></tr></table></figure>

<p><font color="orange">检查是否成功(bip=172.17.74.1)</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s_node2 ~]# ps -ef | grep docker</span><br><span class="line">root        2958       1  0 05:11 ?        00:00:14 /usr/bin/dockerd-current --bip=172.17.74.1/24 --ip-masq=false --mtu=1450</span><br><span class="line">root        2964    2958  0 05:11 ?        00:00:09 /usr/bin/docker-containerd-current -l unix:///var/run/docker/libcontainerd/docker-containerd.sock --metrics-interval=0 --start-timeout 2m --state-dir /var/run/docker/libcontainerd/containerd --shim docker-containerd-shim --runtime docker-runc</span><br><span class="line">root       11400    1776  0 06:46 pts/0    00:00:00 grep --color=auto docker</span><br><span class="line"></span><br><span class="line">#--------------------------------------------------------------------------------</span><br><span class="line">#ifconfig</span><br><span class="line">docker0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.17.74.1  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">flannel.1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">        inet 172.17.74.0  netmask 255.255.255.255  broadcast 0.0.0.0</span><br></pre></td></tr></table></figure>

<p><font color="red">确保docker0与flannel.1在同一个网段</font></p>
<p><font color="orange">为了测试不同node之间互通，在任意一个node上ping另一个node的docker0的ip</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">##### k8s_node1——&gt;172.17.74.0/16 #####</span><br><span class="line">##### k8s_node2——&gt;172.17.76.0/16 #####</span><br><span class="line"></span><br><span class="line">[root@k8s_node2 ~]# ping 172.17.76.0</span><br><span class="line">PING 172.17.76.0 (172.17.76.0) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.76.0: icmp_seq=1 ttl=64 time=0.973 ms</span><br><span class="line">64 bytes from 172.17.76.0: icmp_seq=2 ttl=64 time=0.264 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.17.76.0 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span><br><span class="line">rtt min/avg/max/mdev = 0.264/0.618/0.973/0.355 ms</span><br><span class="line">[root@k8s_node2 ~]# ping 172.17.76.1</span><br><span class="line">PING 172.17.76.1 (172.17.76.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.76.1: icmp_seq=1 ttl=64 time=0.389 ms</span><br><span class="line">64 bytes from 172.17.76.1: icmp_seq=2 ttl=64 time=0.447 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.17.76.1 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span><br><span class="line">rtt min/avg/max/mdev = 0.389/0.418/0.447/0.029 ms</span><br><span class="line">[root@k8s_node2 ~]# ping 172.17.74.0</span><br><span class="line">PING 172.17.74.0 (172.17.74.0) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.74.0: icmp_seq=1 ttl=64 time=0.125 ms</span><br><span class="line">64 bytes from 172.17.74.0: icmp_seq=2 ttl=64 time=0.043 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.17.74.0 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 999ms</span><br><span class="line">rtt min/avg/max/mdev = 0.043/0.084/0.125/0.041 ms</span><br><span class="line">[root@k8s_node2 ~]# ping 172.17.74.1</span><br><span class="line">PING 172.17.74.1 (172.17.74.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.74.1: icmp_seq=1 ttl=64 time=0.090 ms</span><br><span class="line">64 bytes from 172.17.74.1: icmp_seq=2 ttl=64 time=0.031 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.17.74.1 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1000ms</span><br><span class="line">rtt min/avg/max/mdev = 0.031/0.060/0.090/0.030 ms</span><br></pre></td></tr></table></figure>

<p><strong>如果你都没有问题，则说明Flannel部署成功！</strong></p>
<p><font color="green">一些细节</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s_master1 cfg]# tree /opt/etcd/</span><br><span class="line">/opt/etcd/</span><br><span class="line">├── bin</span><br><span class="line">│   ├── etcd</span><br><span class="line">│   └── etcdctl</span><br><span class="line">├── cfg</span><br><span class="line">│   └── etcd</span><br><span class="line">└── ssl</span><br><span class="line">    ├── ca.pem</span><br><span class="line">    ├── server-key.pem</span><br><span class="line">    └── server.pem</span><br><span class="line"></span><br><span class="line">[root@k8s_master1 cfg]# tree /opt/kubernetes/</span><br><span class="line">/opt/kubernetes/</span><br><span class="line">├── bin</span><br><span class="line">│   ├── flanneld</span><br><span class="line">│   └── mk-docker-opts.sh</span><br><span class="line">├── cfg</span><br><span class="line">│   └── flanneld</span><br><span class="line">└── ssl</span><br><span class="line"></span><br><span class="line">[root@k8s_master1 wangzichen]# tree /home/etcd</span><br><span class="line">/home/etcd</span><br><span class="line">├── ca-config.json</span><br><span class="line">├── ca-.csr</span><br><span class="line">├── ca.csr</span><br><span class="line">├── ca-csr.json</span><br><span class="line">├── ca-key.pem</span><br><span class="line">├── ca.pem</span><br><span class="line">├── generate_etcd_cert.sh</span><br><span class="line">├── server.csr</span><br><span class="line">├── server-csr.json</span><br><span class="line">├── server-key.pem</span><br><span class="line">└── server.pem</span><br><span class="line"></span><br><span class="line">#----------------------------------------------------------------------------------</span><br><span class="line">[root@k8s_node1 opt]# tree etcd/</span><br><span class="line">etcd/</span><br><span class="line">├── bin</span><br><span class="line">│   ├── etcd</span><br><span class="line">│   └── etcdctl</span><br><span class="line">├── cfg</span><br><span class="line">│   └── etcd</span><br><span class="line">└── ssl</span><br><span class="line">    ├── ca.pem</span><br><span class="line">    ├── server-key.pem</span><br><span class="line">    └── server.pem</span><br><span class="line"></span><br><span class="line">[root@k8s_node1 opt]# tree kubernetes/</span><br><span class="line">kubernetes/</span><br><span class="line">├── bin</span><br><span class="line">│   ├── flanneld</span><br><span class="line">│   └── mk-docker-opts.sh</span><br><span class="line">├── cfg</span><br><span class="line">│   └── flanneld</span><br><span class="line">└── ssl</span><br><span class="line"></span><br><span class="line">#----------------------------------------------------------------------------------</span><br><span class="line">[root@k8s_node2 ~]# tree /opt/etcd/</span><br><span class="line">/opt/etcd/</span><br><span class="line">├── bin</span><br><span class="line">│   ├── etcd</span><br><span class="line">│   └── etcdctl</span><br><span class="line">├── cfg</span><br><span class="line">│   └── etcd</span><br><span class="line">└── ssl</span><br><span class="line">    ├── ca.pem</span><br><span class="line">    ├── server-key.pem</span><br><span class="line">    └── server.pem</span><br><span class="line"></span><br><span class="line">[root@k8s_node2 ~]# tree /opt/kubernetes/</span><br><span class="line">/opt/kubernetes/</span><br><span class="line">├── bin</span><br><span class="line">│   ├── flanneld</span><br><span class="line">│   └── mk-docker-opts.sh</span><br><span class="line">├── cfg</span><br><span class="line">│   └── flanneld</span><br><span class="line">└── ssl</span><br></pre></td></tr></table></figure>

<h3 id="八、Master节点部署组件"><a href="#八、Master节点部署组件" class="headerlink" title="八、Master节点部署组件"></a>八、Master节点部署组件</h3><p>在部署Kubernetes之前一定要保证etcd，flannel，docker是正常工作的。</p>
<h4 id="生成证书（和etcd证书不同）"><a href="#生成证书（和etcd证书不同）" class="headerlink" title="生成证书（和etcd证书不同）"></a>生成证书（和etcd证书不同）</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd /home/k8s在此目录下创建json文件</span></span><br><span class="line"><span class="comment"># cat ca-config.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">  "signing":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "default":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">      "expiry":</span> <span class="string">"87600h"</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">    "profiles":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">      "kubernetes":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">         "expiry":</span> <span class="string">"87600h"</span><span class="string">,</span></span><br><span class="line"><span class="attr">         "usages":</span> <span class="string">[</span></span><br><span class="line">            <span class="string">"signing"</span><span class="string">,</span></span><br><span class="line">            <span class="string">"key encipherment"</span><span class="string">,</span></span><br><span class="line">            <span class="string">"server auth"</span><span class="string">,</span></span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        <span class="string">]</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat ca-csr.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "CN":</span> <span class="string">"kubernetes"</span><span class="string">,</span></span><br><span class="line"><span class="attr">    "key":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">        "algo":</span> <span class="string">"rsa"</span><span class="string">,</span></span><br><span class="line"><span class="attr">        "size":</span> <span class="number">2048</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">    "names":</span> <span class="string">[</span></span><br><span class="line">        <span class="string">&#123;</span></span><br><span class="line"><span class="attr">            "C":</span> <span class="string">"CN"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "L":</span> <span class="string">"Beijing"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "ST":</span> <span class="string">"Beijing"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "O":</span> <span class="string">"k8s"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "OU":</span> <span class="string">"System"</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成apiserver证书</span></span><br><span class="line"><span class="comment"># cat server-csr.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "CN":</span> <span class="string">"kubernetes"</span><span class="string">,</span></span><br><span class="line"><span class="attr">    "hosts":</span> <span class="string">[</span></span><br><span class="line">      <span class="string">"10.0.0.1"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"127.0.0.1"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"192.168.18.80"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"kubernetes"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"kubernetes.default"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"kubernetes.default.svc"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"kubernetes.default.svc.cluster"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">    <span class="string">],</span></span><br><span class="line"><span class="attr">    "key":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">        "algo":</span> <span class="string">"rsa"</span><span class="string">,</span></span><br><span class="line"><span class="attr">        "size":</span> <span class="number">2048</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">    "names":</span> <span class="string">[</span></span><br><span class="line">        <span class="string">&#123;</span></span><br><span class="line"><span class="attr">            "C":</span> <span class="string">"CN"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "L":</span> <span class="string">"BeiJing"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "ST":</span> <span class="string">"BeiJing"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "O":</span> <span class="string">"k8s"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "OU":</span> <span class="string">"System"</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="comment">#cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># 生成kube-proxy证书</span></span><br><span class="line"><span class="comment"># cat kube-proxy-csr.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">  "CN":</span> <span class="string">"system:kube-proxy"</span><span class="string">,</span></span><br><span class="line"><span class="attr">  "hosts":</span> <span class="string">[],</span></span><br><span class="line"><span class="attr">  "key":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "algo":</span> <span class="string">"rsa"</span><span class="string">,</span></span><br><span class="line"><span class="attr">    "size":</span> <span class="number">2048</span></span><br><span class="line">  <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">  "names":</span> <span class="string">[</span></span><br><span class="line">    <span class="string">&#123;</span></span><br><span class="line"><span class="attr">      "C":</span> <span class="string">"CN"</span><span class="string">,</span></span><br><span class="line"><span class="attr">      "L":</span> <span class="string">"BeiJing"</span><span class="string">,</span></span><br><span class="line"><span class="attr">      "ST":</span> <span class="string">"BeiJing"</span><span class="string">,</span></span><br><span class="line"><span class="attr">      "O":</span> <span class="string">"k8s"</span><span class="string">,</span></span><br><span class="line"><span class="attr">      "OU":</span> <span class="string">"System"</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">  <span class="string">]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># 每个创建json文件后，在命令行执行每个后面的命令</span></span><br><span class="line"><span class="string">[root@k8s_master1</span> <span class="string">k8s]#</span> <span class="string">ll</span></span><br><span class="line"><span class="string">total</span> <span class="number">72</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-------</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">2167</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">22</span><span class="string">:05</span> <span class="string">bootstrap.kubeconfig</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">294</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:43</span> <span class="string">ca-config.json</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1001</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:43</span> <span class="string">ca.csr</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">265</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:43</span> <span class="string">ca-csr.json</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-------</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1679</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:43</span> <span class="string">ca-key.pem</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1359</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:43</span> <span class="string">ca.pem</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1870</span> <span class="string">Apr</span>  <span class="number">9</span> <span class="number">19</span><span class="string">:11</span> <span class="string">etcd.sh</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1009</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:44</span> <span class="string">kube-proxy.csr</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">230</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:44</span> <span class="string">kube-proxy-csr.json</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-------</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1675</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:44</span> <span class="string">kube-proxy-key.pem</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-------</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">6269</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">22</span><span class="string">:05</span> <span class="string">kube-proxy.kubeconfig</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1403</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:44</span> <span class="string">kube-proxy.pem</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rwxrwxrwx</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1329</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">22</span><span class="string">:05</span> <span class="string">kubernetes.sh</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1245</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:44</span> <span class="string">server.csr</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">511</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:44</span> <span class="string">server-csr.json</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-------</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1675</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:44</span> <span class="string">server-key.pem</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1610</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:44</span> <span class="string">server.pem</span></span><br><span class="line"><span class="comment"># 会有6个以pem结尾的文件，则成功</span></span><br></pre></td></tr></table></figure>

<h4 id="部署apiserver组件"><a href="#部署apiserver组件" class="headerlink" title="部署apiserver组件"></a>部署apiserver组件</h4><p>下载二进制包<a href="https://pan.baidu.com/s/1B_rbab9t6ufY7daSpeuQTg" target="_blank" rel="noopener">附百度云链接</a>，里面有3个版本，直接找<strong>kubernetes-server-linux-amd64.tar.gz</strong>即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> mkdir /opt/kubernetes/&#123;bin,cfg,ssl&#125; -p</span><br><span class="line"><span class="meta">#</span> tar -zxvf kubernetes-server-linux-amd64.tar.gz ./</span><br><span class="line"><span class="meta">#</span> cd kubernetes/server/bin</span><br><span class="line"><span class="meta">#</span> cp kube-apiserver kube-scheduler kube-controller-manager kubectl /opt/kubernetes/bin</span><br></pre></td></tr></table></figure>

<p><font color="orange">创建token文件，用途之后会有用到</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /opt/kubernetes/cfg/token.csv</span><br><span class="line">674c457d4dcf2eefe4920d7dbb6b0ddc,</span><br><span class="line">kubelet-bootstrap,</span><br><span class="line">10001,</span><br><span class="line">"system:kubelet-bootstrap"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>第一列：随机字符串，自己可生成</span><br><span class="line"><span class="meta">#</span>第二列：用户名</span><br><span class="line"><span class="meta">#</span>第三列：UID</span><br><span class="line"><span class="meta">#</span>第四列：用户组</span><br></pre></td></tr></table></figure>

<p><font color="orange">创建apiserver配置文件</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /opt/kubernetes/cfg/kube-apiserver </span><br><span class="line"></span><br><span class="line">KUBE_APISERVER_OPTS="--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--etcd-servers=https://192.168.18.80:2379,https://192.168.18.85:2379,https://192.168.18.86:2379 \</span><br><span class="line">--bind-address=192.168.18.80 \</span><br><span class="line">--secure-port=6443 \</span><br><span class="line">--advertise-address=192.168.18.80 \</span><br><span class="line">--allow-privileged=true \</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota,NodeRestriction \</span><br><span class="line">--authorization-mode=RBAC,Node \</span><br><span class="line">--enable-bootstrap-token-auth \</span><br><span class="line">--token-auth-file=/opt/kubernetes/cfg/token.csv \</span><br><span class="line">--service-node-port-range=30000-50000 \</span><br><span class="line">--tls-cert-file=/opt/kubernetes/ssl/server.pem  \</span><br><span class="line">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \</span><br><span class="line">--client-ca-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \</span><br><span class="line">--etcd-cafile=/opt/etcd/ssl/ca.pem \</span><br><span class="line">--etcd-certfile=/opt/etcd/ssl/server.pem \</span><br><span class="line">--etcd-keyfile=/opt/etcd/ssl/server-key.pem"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>---------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line">–logtostderr 启用日志</span><br><span class="line">—v 日志等级</span><br><span class="line">–etcd-servers etcd集群地址</span><br><span class="line">–bind-address 监听地址</span><br><span class="line">–secure-port https安全端口</span><br><span class="line">–advertise-address 集群通告地址</span><br><span class="line">–allow-privileged 启用授权</span><br><span class="line">–service-cluster-ip-range Service虚拟IP地址段</span><br><span class="line">–enable-admission-plugins 准入控制模块</span><br><span class="line">–authorization-mode 认证授权，启用RBAC授权和节点自管理</span><br><span class="line">–enable-bootstrap-token-auth 启用TLS bootstrap功能，后面会讲到</span><br><span class="line">–token-auth-file token文件</span><br><span class="line">–service-node-port-range Service Node类型默认分配端口范围</span><br></pre></td></tr></table></figure>

<p><font color="orange">systemd管理apiserver</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /usr/lib/systemd/system/kube-apiserver.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-apiserver</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-apiserver $KUBE_APISERVER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><font color="orange">启动</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> systemctl daemon-reload</span><br><span class="line"><span class="meta">#</span> systemctl enable kube-apiserver</span><br><span class="line"><span class="meta">#</span> systemctl restart kube-apiserver</span><br></pre></td></tr></table></figure>

<h4 id="部署scheduler组件"><a href="#部署scheduler组件" class="headerlink" title="部署scheduler组件"></a>部署scheduler组件</h4><p><font color="orange">创建scheduler组件</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /opt/kubernetes/cfg/kube-scheduler </span><br><span class="line"></span><br><span class="line">KUBE_SCHEDULER_OPTS="--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--master=127.0.0.1:8080 \</span><br><span class="line">--leader-elect"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>---------------------------------------------------------------------------------</span><br><span class="line">参数说明：</span><br><span class="line">–master 连接本地apiserver</span><br><span class="line">–leader-elect 当该组件启动多个时，自动选举（HA）</span><br></pre></td></tr></table></figure>

<p><font color="orange">systemd管理scheduler组件</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /usr/lib/systemd/system/kube-scheduler.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-scheduler</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-scheduler $KUBE_SCHEDULER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><font color="orange">启动</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> systemctl daemon-reload</span><br><span class="line"><span class="meta">#</span> systemctl enable kube-scheduler</span><br><span class="line"><span class="meta">#</span> systemctl restart kube-scheduler</span><br></pre></td></tr></table></figure>

<h4 id="部署controller-manager组件"><a href="#部署controller-manager组件" class="headerlink" title="部署controller-manager组件"></a>部署controller-manager组件</h4><p><font color="orange">创建controller-manager组件</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /opt/kubernetes/cfg/kube-controller-manager </span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS="--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--master=127.0.0.1:8080 \</span><br><span class="line">--leader-elect=true \</span><br><span class="line">--address=127.0.0.1 \</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \</span><br><span class="line">--cluster-name=kubernetes \</span><br><span class="line">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \</span><br><span class="line">--root-ca-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem"</span><br></pre></td></tr></table></figure>

<p><font color="orange">systemd管理controller-manager组件</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /usr/lib/systemd/system/kube-controller-manager.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-controller-manager</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><font color="orange">启动</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> systemctl daemon-reload</span><br><span class="line"><span class="meta">#</span> systemctl enable kube-controller-manager</span><br><span class="line"><span class="meta">#</span> systemctl restart kube-controller-manager</span><br></pre></td></tr></table></figure>

<p><strong>至此，所有组件都启动成功，通过kubectl工具查看当前集群组件状态</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s_master1 k8s]# kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">etcd-2               Healthy   &#123;"health": "true"&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;"health": "true"&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;"health": "true"&#125;</span><br></pre></td></tr></table></figure>

<h3 id="九、Node节点部署组件"><a href="#九、Node节点部署组件" class="headerlink" title="九、Node节点部署组件"></a>九、Node节点部署组件</h3><p>Master apiserver启用TLS认证后，Node节点kubelet组件想要加入集群，必须使用CA签发的有效证书才能与apiserver通信，当Node节点很多时，签署证书是一件很繁琐的事情，因此有了TLS Bootstrapping机制，kubelet会以一个低权限用户自动向apiserver申请证书，kubelet的证书由apiserver动态签署。</p>
<h4 id="将kubelet-bootstrap用户绑定到系统集群角色"><a href="#将kubelet-bootstrap用户绑定到系统集群角色" class="headerlink" title="将kubelet-bootstrap用户绑定到系统集群角色"></a>将kubelet-bootstrap用户绑定到系统集群角色</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">  --clusterrole=system:node-bootstrapper \</span><br><span class="line">  --user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>

<h4 id="创建kubeconfig文件"><a href="#创建kubeconfig文件" class="headerlink" title="创建kubeconfig文件"></a>创建kubeconfig文件</h4><p><strong>在生成kubernetes证书的目录下执行以下命令生成kubeconfig文件（/home/k8s），创建kubernetes.sh</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 创建kubelet bootstrapping kubeconfig </span><br><span class="line">BOOTSTRAP_TOKEN=674c457d4dcf2eefe4920d7dbb6b0ddc</span><br><span class="line">KUBE_APISERVER=&quot;https://192.168.18.80:6443&quot;</span><br><span class="line"></span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=./ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">  --token=$&#123;BOOTSTRAP_TOKEN&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubelet-bootstrap \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">#-------------------------------------------------------------------</span><br><span class="line">#-------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"># 创建kube-proxy kubeconfig文件</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=./ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=./kube-proxy.pem \</span><br><span class="line">  --client-key=./kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p><font color="gree">在写完上述的shell脚本后，执行chmod 777 kubernetes.sh，执行./kubernetes.sh</font></p>
<p>这时可以发现生成了<strong>bootstrap.kubeconfig</strong>和<strong>kube-proxy.kubeconfig</strong>两个文件（妥善保存，一旦泄露，集群炸了），将这两个文件通过scp发送到所有<strong>Node节点的/opt/kubernetes/cfg</strong>目录下。</p>
<p><font color="scarlet">解释一下，双注释之上的代码主要是为了在node节点上执行在master节点上的命令，需要将master节点上的kubectl通过scp发送到所有node的/opt/kubernetes/bin下，同时修改<strong>/etc/profile</strong>文件，添加环境变量<strong>export PATH=$PATH:/opt/kubernetes/bin/</strong>，同时node节点需要cd到放有kubelet.kubeconfig的目录下执行<strong>kubectl get nodes –kubeconfig=kubelet.kubeconfig</strong>命令。</font></p>
<h4 id="部署kubelet组件"><a href="#部署kubelet组件" class="headerlink" title="部署kubelet组件"></a>部署kubelet组件</h4><p>解压<strong>kubernetes-server-linux-amd64.tar.gz</strong>后，在<strong>/kubernetes/server/bin</strong>下找到<strong>kubelet</strong>和<strong>kube-proxy</strong>两个文件，将这两个文件拷贝到<strong>Node节点的/opt/kubernetes/bin</strong>目录下。</p>
<p><font color="orange">创建kubelet配置文件</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /opt/kubernetes/cfg/kubelet</span><br><span class="line">KUBELET_OPTS="--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--hostname-override=192.168.18.85 \</span><br><span class="line">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \</span><br><span class="line">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \</span><br><span class="line">--config=/opt/kubernetes/cfg/kubelet.config \</span><br><span class="line">--cert-dir=/opt/kubernetes/ssl \</span><br><span class="line">--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>----------------------------------------------------------------------------------</span><br><span class="line">参数说明：</span><br><span class="line">–hostname-override 在集群中显示的主机名</span><br><span class="line">–kubeconfig 指定kubeconfig文件位置，会自动生成</span><br><span class="line">–bootstrap-kubeconfig 指定刚才生成的bootstrap.kubeconfig文件</span><br><span class="line">–cert-dir 颁发证书存放位置</span><br><span class="line">–pod-infra-container-image 管理Pod网络的镜像</span><br></pre></td></tr></table></figure>

<p>其中第7行的kubelet.config配置文件如下，位置位于<strong>Node节点的/opt/kubernetes/cfg/kubelet.config</strong>下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">address:</span> <span class="number">192.168</span><span class="number">.18</span><span class="number">.85</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">10250</span></span><br><span class="line"><span class="attr">readOnlyPort:</span> <span class="number">10255</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">cgroupfs</span></span><br><span class="line"><span class="attr">clusterDNS:</span> <span class="string">["10.0.0.2"]</span></span><br><span class="line"><span class="attr">clusterDomain:</span> <span class="string">cluster.local.</span></span><br><span class="line"><span class="attr">failSwapOn:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">authentication:</span></span><br><span class="line"><span class="attr">  anonymous:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><font color="orange">systemd管理kubelet组件</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /usr/lib/systemd/system/kubelet.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kubelet</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kubelet $KUBELET_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><font color="orange">启动</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> systemctl daemon-reload</span><br><span class="line"><span class="meta">#</span> systemctl enable kubelet</span><br><span class="line"><span class="meta">#</span> systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<p><strong>上述操作在所有Node节点都要执行，在启动后还是没有加入到集群中，这时需要Master手动允许才可以。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> kubectl get csr</span><br><span class="line"><span class="meta">#</span> kubectl certificate approve XXXXID</span><br><span class="line"><span class="meta">#</span> kubectl get node</span><br><span class="line"><span class="meta">#</span>-----------------------------------------------------------</span><br><span class="line">如：kubectl get csr</span><br><span class="line">   kubectl certificate approve node-csr-PjBnNDUYsE1soevzLVunyjrCWDEOj_bMUo7ypVuQOXs</span><br></pre></td></tr></table></figure>

<h4 id="部署kube-proxy组件"><a href="#部署kube-proxy组件" class="headerlink" title="部署kube-proxy组件"></a>部署kube-proxy组件</h4><p><font color="orange">创建kube-proxy配置文件</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /opt/kubernetes/cfg/kube-proxy</span><br><span class="line">KUBE_PROXY_OPTS="--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--hostname-override=192.168.18.85 \</span><br><span class="line">--cluster-cidr=10.0.0.0/24 \</span><br><span class="line">--kubeconfig=/opt/kubernetes/cfg/kube-proxy.kubeconfig"</span><br></pre></td></tr></table></figure>

<p><font color="orange">systemd管理Kube-proxy组件</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /usr/lib/systemd/system/kube-proxy.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-proxy</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-proxy $KUBE_PROXY_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><font color="orange">启动</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> systemctl daemon-reload</span><br><span class="line"><span class="meta">#</span> systemctl enable kube-proxy</span><br><span class="line"><span class="meta">#</span> systemctl restart kube-proxy</span><br></pre></td></tr></table></figure>

<p><strong>同样的，上述操作在每个Node节点都要执行</strong></p>
<h4 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s_master1 bin]# kubectl get node</span><br><span class="line">NAME            STATUS   ROLES    AGE     VERSION</span><br><span class="line">192.168.18.85   Ready    &lt;none&gt;   3h52m   v1.12.1</span><br><span class="line">192.168.18.86   Ready    &lt;none&gt;   3h42m   v1.12.1</span><br><span class="line">[root@k8s_master1 bin]# kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">etcd-1               Healthy   &#123;"health": "true"&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;"health": "true"&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;"health": "true"&#125;</span><br></pre></td></tr></table></figure>

<h3 id="十、运行测试"><a href="#十、运行测试" class="headerlink" title="十、运行测试"></a>十、运行测试</h3><p><font color="orange">创建一个Nginx Web，测试集群是否正常工作</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> kubectl run nginx --image=nginx --replicas=3</span><br><span class="line"><span class="meta">#</span> kubectl expose deployment nginx --port=88 --target-port=80 --type=NodePort</span><br></pre></td></tr></table></figure>

<p><font color="orange">查看pod，service</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s_master1 bin]# kubectl get pods</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-dbddb74b8-4cd2k   1/1     Running   0          110m</span><br><span class="line">nginx-dbddb74b8-css9h   1/1     Running   0          110m</span><br><span class="line">nginx-dbddb74b8-mbkdg   1/1     Running   0          110m</span><br><span class="line">[root@k8s_master1 bin]# kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes   ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP        6h44m</span><br><span class="line">nginx        NodePort    10.0.0.228   &lt;none&gt;        88:42959/TCP   110m</span><br></pre></td></tr></table></figure>

<p>在本地浏览器输入Node的ip加上Nginx的port（如：42959），应该会访问到。</p>
<img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s_test.png">



<h3 id="十一、安装kuboard可视化界面"><a href="#十一、安装kuboard可视化界面" class="headerlink" title="十一、安装kuboard可视化界面"></a>十一、安装kuboard可视化界面</h3><ul>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 可以在master节点执行以下命令</span><br><span class="line">kubectl apply -f https://kuboard.cn/install-script/kuboard.yaml</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 查看kuboard运行状态</span><br><span class="line">[root@k8s_master1 ~]# kubectl get pods -l k8s.eip.work/name=kuboard -n kube-system</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kuboard-56b99986dc-9zsqg   1/1     Running   1          15h</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 获取Token,登录界面需要token</span><br><span class="line">[root@k8s_master1 ~]# kubectl -n kube-system get secret $(kubectl -n kube-system get secret | grep kuboard-user | awk '&#123;print $1&#125;') -o go-template='&#123;&#123;.data.token&#125;&#125;' | base64 -d</span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJvYXJkLXVzZXItdG9rZW4tOXQ5ZGIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoia3Vib2FyZC11c2VyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiMWJlMDUxMWItN2I3ZC0xMWVhLWIxMDUtMDAwYzI5YWVhZTQ1Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmt1Ym9hcmQtdXNlciJ9.WqqZGdn_rFBhNiJRYFOT088-afLI3m88IP0U4wJuEbYSwuUkhDodf67j76WpITnCdL5t_dsHJeKBHs9mAUHcUiZIqaCrnPXgsvh7sxi9IhD5CGFj1DqzstiGThGQmY7Su3w1SO-KrmInkfWwkaFIqLjvKUhjxzX4OoO_fJgdLdeUZOAF1gbNg_TC98IhZPFE-qlKTaL2u_5o1OxpzKVWx5z52G6eqeTZiprq39_rhpKQElU3IBLAyU6CtLsmxFF66kxgj9qPaYzpHV6U_Hsw0KtX3qEcNbC0GIxOEw4HFNDABzSUx4dATVWKfg9zeldz5gJB7AumZmmz63lfqFAOIw</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 查看暴露的端口32567</span><br><span class="line">[root@k8s_master1 ~]# kubectl get svc -n kube-system</span><br><span class="line">NAME      TYPE       CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kuboard   NodePort   10.0.0.41    &lt;none&gt;        80:32567/TCP   15h</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 任意一个node节点ip:32567</span><br><span class="line"># http://192.168.18.85:32567</span><br></pre></td></tr></table></figure>

<p><strong>运行结果如下：</strong></p>
<img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/kuboard.png">

</li>
</ul>
<p><font color="navy blue">至此，一个单master的Kubernetes集群已经创建成功了！可能还有一些组件没有安装（coreDns等等）</font></p>
<hr>
<h4 id="总结暂时出现的问题"><a href="#总结暂时出现的问题" class="headerlink" title="总结暂时出现的问题"></a>总结暂时出现的问题</h4><ul>
<li><p>部署kubectl run nginx –image=nginx –replicas=3和kubectl expose deployment nginx –port=88 –target-port=80 –type=NodePort时，kubectl get pods总是<strong>ContainerCreating</strong>，一直没有出现Running，之后通过<strong>kubectl describe pod nginx</strong>查看详细信息，在Event的那一行有个<strong>warning：shim error: docker-runc not installed on system</strong>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第一种方法：修改/etc/docker/daemon.json文件。</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "log-level":</span><span class="string">"warn"</span><span class="string">,</span></span><br><span class="line"><span class="attr">    "runtimes":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">        "docker-runc":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">            "path":</span> <span class="string">"/usr/libexec/docker/docker-runc-current"</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">    "add-runtime":</span> <span class="string">"docker-runc=/usr/libexec/docker/docker-runc-current"</span><span class="string">,</span></span><br><span class="line"><span class="attr">    "default-runtime":</span> <span class="string">"docker-runc"</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>第二种方法</span><br><span class="line">cd /usr/libexec/docker/</span><br><span class="line">sudo ln -s docker-runc-current docker-runc</span><br></pre></td></tr></table></figure>
</li>
<li><p>还有一种情况，有的时候systemctl restart docker总是有问题，我会将docker完全卸载，再重新安装一次，注意，重新安装要修改/usr/lib/systemd/system/docker.service这个文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>#docker卸载安装</span><br><span class="line"><span class="meta">#</span>1、先查询下docker</span><br><span class="line">yum list installed | grep docker</span><br><span class="line"><span class="meta">#</span>2、执行卸载命令</span><br><span class="line">yum -y remove docker.x86_64 docker-client.x86_64</span><br><span class="line"><span class="meta">#</span>3、执行删除已存在的镜像和容器</span><br><span class="line">rm -rf /var/lib/docker/</span><br><span class="line"><span class="meta">#</span>4、重新安装docker</span><br><span class="line">yum install -y docker</span><br></pre></td></tr></table></figure>

</li>
</ul>
<hr>
<h3 id="补充：k8s使用入门"><a href="#补充：k8s使用入门" class="headerlink" title="补充：k8s使用入门"></a>补充：k8s使用入门</h3><ul>
<li><strong>deployment：</strong>1、创建指定数量的pod               2、检查pod健康状态和数量<ul>
<li>基于deployment创建nginx pod，有一个副本<ul>
<li>方法一、<code>[root@k8s_master1 ~]# kubectl run nginx-dep1 --image=nginx:1.8 --replicas=1</code></li>
<li>方法二、<code>通过Kuboard来创建</code></li>
<li>方法三、<code>通过yaml文件来创建</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@k8s_master1</span> <span class="string">yaml]#</span> <span class="string">cat</span> <span class="string">nginx-dep.yaml</span> </span><br><span class="line"><span class="comment">#执行api版本信息</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#类型</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#元数据(deployment的标签)</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ngx-dep</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">webservice</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#副本|选择器</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span> </span><br><span class="line"><span class="attr">        app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">        type:</span> <span class="string">webservice</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">nginx:1.8</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@k8s_master1</span> <span class="string">yaml]#</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="bullet">-f</span> <span class="string">nginx-dep.yaml</span> </span><br><span class="line"><span class="string">deployment.apps/ngx-dep</span> <span class="string">created</span></span><br><span class="line"><span class="string">[root@k8s_master1</span> <span class="string">yaml]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span></span><br><span class="line"><span class="string">NAME</span>                       <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">ngx-dep-5ccc65dd98-mdpsz</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="string">[root@k8s_master1</span> <span class="string">yaml]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="bullet">-o</span> <span class="string">wide</span></span><br><span class="line"><span class="string">NAME</span>                       <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>     <span class="string">IP</span>            <span class="string">NODE</span>            <span class="string">NOMINATED</span> <span class="string">NODE</span></span><br><span class="line"><span class="string">ngx-dep-5ccc65dd98-mdpsz</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">3</span><span class="string">m30s</span>   <span class="number">172.17</span><span class="number">.76</span><span class="number">.2</span>   <span class="number">192.168</span><span class="number">.18</span><span class="number">.85</span>   <span class="string">&lt;none&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>查看k8s对象状态</p>
<ul>
<li>kubctl get 资源类型<ul>
<li>资源类型：node，pod，service，deployment，namespace…</li>
<li>选项：-n namespace或者-A等等（指定命名空间kubectl get pods –namespace=development）</li>
<li>例：显示所有名称空间中的pod（<code>kubectl get pod -A -o wide</code>）</li>
</ul>
</li>
<li>kubectl describe 资源类型<ul>
<li><code>kubectl describe pod ngx-dep-5ccc65dd98-mdpsz</code></li>
<li><code>kubectl describe node k8s_node1</code></li>
<li><code>kubectl logs pod ngx-dep-5ccc65dd98-mdpsz</code></li>
<li>登录容器<code>kubectl exec -it ngx-dep-5ccc65dd98-mdpsz /bin/bash</code></li>
</ul>
</li>
</ul>
</li>
<li><p>发布应用</p>
<ul>
<li>用service来发布服务（创建yaml并执行）</li>
</ul>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ngx-svc</span></span><br><span class="line"><span class="attr">  labels:</span> </span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  ports:</span> </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">nginx-ports</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    nodePort:</span> <span class="number">32123</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">#等同于kubectl expose deployment nginx --port=80 --target-port=80 --type=NodePort</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>服务伸缩（Scalling）弹性管理</p>
<ul>
<li>即修改副本的数量replicas</li>
</ul>
</li>
<li><p>滚动更新</p>
<ul>
<li>例：若是将3个nginx:1.7更新成nginx:1.8，需要先创建一个1.8来替换一个1.7，重复操作</li>
<li>修改yaml的image的信息</li>
</ul>
</li>
<li><p>k8s通用迁移流程</p>
<ul>
<li>制作镜像</li>
<li>将镜像启动为pod</li>
<li>暴露应用（内部）</li>
<li>对外发布应用</li>
<li>监控/日志</li>
</ul>
</li>
<li><p>镜像类别</p>
<ul>
<li>镜像作用：一个镜像中运行一个服务</li>
<li>三类镜像：<ul>
<li>基础镜像（纯净版centos系统等等）</li>
<li>运行环境镜像（加入jdk，mysql，php）</li>
<li>项目镜像（加入项目代码）</li>
</ul>
</li>
</ul>
</li>
</ul>

      
      <!-- reward -->
      
      <div id="reward-btn">
        打赏
      </div>
      
    </div>
    
    
      <!-- copyright -->
      
        <div class="declare">
          <ul class="post-copyright">
            <li>
              <i class="ri-copyright-line"></i>
              <strong>版权声明： </strong s>
              本博客所有文章除特别声明外，均采用 <a href="https://www.apache.org/licenses/LICENSE-2.0.html" rel="external nofollow"
                target="_blank">Apache License 2.0</a> 许可协议。转载请注明出处！
            </li>
          </ul>
        </div>
        
    <footer class="article-footer">
      
          
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://www.codedog.fun/2020/04/12/Kubernetes(k8s)个人笔记(更新中)/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li></ul>


    </footer>

  </div>

  
  
  <nav class="article-nav">
    
      <a href="/2020/04/13/4-13/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            设计推特
          
        </div>
      </a>
    
    
      <a href="/2020/04/12/4-12/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">交点</div>
      </a>
    
  </nav>


  

  
  
<!-- valine评论 -->
<div id="vcomments-box">
    <div id="vcomments">
    </div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: '1yf8gY1YRw7AbvWoiPFYoY3x-gzGzoHsz',
        app_key: '0W6HVhxWDB0tDqkv2z0ta0S7',
        path: window.location.pathname,
        notify: 'true',
        verify: 'true',
        avatar: 'mp',
        placeholder: '给我的文章加点评论吧~',
        recordIP: true
    });
    const infoEle = document.querySelector('#vcomments .info');
    if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
        infoEle.childNodes.forEach(function (item) {
            item.parentNode.removeChild(item);
        });
    }
</script>
<style>
    #vcomments-box {
        padding: 5px 30px;
    }

    @media screen and (max-width: 800px) {
        #vcomments-box {
            padding: 5px 0px;
        }
    }

    #vcomments-box #vcomments {
        background-color: #fff;
    }

    .v .vlist .vcard .vh {
        padding-right: 20px;
    }

    .v .vlist .vcard {
        padding-left: 10px;
    }
</style>

  

  
  
  

</article>
</section>
      <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>
        &copy;
        2019-2020
        WangZiChen
      </li>
      <li>
        
      </li>
    </ul>
    <ul class="list-inline">
      <li>
        
        
        <span>
  <i>PV:<span id="busuanzi_value_page_pv"></span></i>
  <i>UV:<span id="busuanzi_value_site_uv"></span></i>
</span>
        
      </li>
      
      <li>
        <a href="http://www.beian.miit.gov.cn/" target="_black">苏ICP备19019208号</a>
      </li>
      
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>
      <div class="to_top">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>
      </div>
    </main>
    <aside class="sidebar">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/delisha.jpg" alt="wangzichen的个人博客"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/favourite">收藏</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/photos">壁纸</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/ZFB.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/WX.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/share.js"></script>
<script src="/js/lazyload.min.js"></script>

<script>
  try {
    var typed = new Typed("#subtitle", {
      strings: ['好好学习,天天向上', '每天坚持一点点', ''],
      startDelay: 0,
      typeSpeed: 180,
      loop: true,
      backSpeed: 180,
      showCursor: false
    });
  } catch (err) {
  }

</script>



<script src="/js/tocbot.min.js"></script>
<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
    onClick: (e) => {
      $('.toc-link').removeClass('is-active-link');
      $(`a[href=${e.target.hash}]`).addClass('is-active-link');
      $(e.target.hash).scrollIntoView();
      return false;
    }
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/ayer.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
  var ayerConfig = {
    mathjax: true
  }
</script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>


<script type="text/javascript" src="https://js.users.51.la/20544303.js"></script>

    
  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-wanko"},"display":{"position":"left","width":75,"height":100},"mobile":{"show":true},"log":false});</script></body>

</html>