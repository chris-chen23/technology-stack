<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
   
  <meta name="keywords" content="ç¨‹åºçŒ¿" />
   
  <meta name="description" content="å¥½å¥½å­¦ä¹ ï¼Œå¤©å¤©å‘ä¸Š" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    Kubernetes(k8s)ä¸ªäººå­¦ä¹ ç¬”è®°(æ›´æ–°ä¸­) |  wangzichençš„ä¸ªäººåšå®¢
  </title>
  <meta name="generator" content="hexo-theme-yilia-plus">
  
  <link rel="shortcut icon" href="/images/favicon.ico" />
  
  <link rel="stylesheet" href="/css/main.css">
  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

  

</head>

</html>

<body>
  <div id="app">
    <main class="content">
      <section class="outer">
  <article id="post-Kubernetes(k8s)ä¸ªäººç¬”è®°(æ›´æ–°ä¸­)" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Kubernetes(k8s)ä¸ªäººå­¦ä¹ ç¬”è®°(æ›´æ–°ä¸­)
</h1>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/04/12/Kubernetes(k8s)ä¸ªäººç¬”è®°(æ›´æ–°ä¸­)/" class="article-date">
  <time datetime="2020-04-12T15:05:43.000Z" itemprop="datePublished">2020-04-12</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/è™šæ‹ŸåŒ–/">è™šæ‹ŸåŒ–</a>
  </div>

      
      
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> å­—æ•°ç»Ÿè®¡:</span>
            <span class="post-count">6.6kå­—</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> é˜…è¯»æ—¶é•¿â‰ˆ</span>
            <span class="post-count">33åˆ†é’Ÿ</span>
        </span>
    </span>
</div>

      
    </div>
    

    
    
    <div class="tocbot"></div>





    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h2 id="Kubernetes-k8s-ä¸ªäººç¬”è®°ğŸ’ª"><a href="#Kubernetes-k8s-ä¸ªäººç¬”è®°ğŸ’ª" class="headerlink" title="Kubernetes(k8s)ä¸ªäººç¬”è®°ğŸ’ª"></a>Kubernetes(k8s)ä¸ªäººç¬”è®°ğŸ’ª</h2><h3 id="ä¸€ã€æ¦‚å¿µ"><a href="#ä¸€ã€æ¦‚å¿µ" class="headerlink" title="ä¸€ã€æ¦‚å¿µ"></a>ä¸€ã€æ¦‚å¿µ</h3><h4 id="ä»€ä¹ˆæ˜¯k8s"><a href="#ä»€ä¹ˆæ˜¯k8s" class="headerlink" title="ä»€ä¹ˆæ˜¯k8s?"></a>ä»€ä¹ˆæ˜¯k8s?</h4><ul>
<li>k8sæ˜¯ä¸€ç»„æœåŠ¡å™¨é›†ç¾¤</li>
<li>K8sæ‰€ç®¡ç†çš„é›†ç¾¤èŠ‚ç‚¹ä¸Šçš„å®¹å™¨</li>
</ul>
<h4 id="k8sçš„åŠŸèƒ½"><a href="#k8sçš„åŠŸèƒ½" class="headerlink" title="k8sçš„åŠŸèƒ½"></a>k8sçš„åŠŸèƒ½</h4><ul>
<li>è‡ªæˆ‘ä¿®å¤</li>
<li>å¼¹æ€§ä¼¸ç¼©ï¼šå®æ—¶æ ¹æ®æœåŠ¡å™¨å¹¶å‘æƒ…å†µï¼Œå¢åŠ æˆ–è€…ç¼©å‡å®¹å™¨æ•°é‡</li>
<li>è‡ªåŠ¨éƒ¨ç½²</li>
<li>å›æ»š</li>
<li>æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</li>
<li>æœºå¯†å’Œé…ç½®å…±äº«ç®¡ç†</li>
</ul>
<a id="more"></a>

<h4 id="k8sé›†ç¾¤åˆ†ä¸ºä¸¤ç±»èŠ‚ç‚¹"><a href="#k8sé›†ç¾¤åˆ†ä¸ºä¸¤ç±»èŠ‚ç‚¹" class="headerlink" title="k8sé›†ç¾¤åˆ†ä¸ºä¸¤ç±»èŠ‚ç‚¹"></a>k8sé›†ç¾¤åˆ†ä¸ºä¸¤ç±»èŠ‚ç‚¹</h4><ul>
<li>master nodeï¼šä¸»</li>
<li>worker nodeï¼šå·¥ä½œ</li>
</ul>
<h4 id="masterèŠ‚ç‚¹ç»„ä»¶"><a href="#masterèŠ‚ç‚¹ç»„ä»¶" class="headerlink" title="masterèŠ‚ç‚¹ç»„ä»¶"></a>masterèŠ‚ç‚¹ç»„ä»¶</h4><ul>
<li>apiserverï¼šæ¥æ”¶å®¢æˆ·ç«¯æ“ä½œk8sçš„æŒ‡ä»¤</li>
<li>schdulerï¼šä»å¤šä¸ªworker nodeèŠ‚ç‚¹çš„ç»„ä»¶ä¸­é€‰ä¸¾ä¸€ä¸ªæ¥å¯åŠ¨æœåŠ¡</li>
<li>controller managerï¼šå‘workerèŠ‚ç‚¹çš„kubeletå‘é€æŒ‡ä»¤</li>
</ul>
<h4 id="workder-nodeèŠ‚ç‚¹ç»„ä»¶"><a href="#workder-nodeèŠ‚ç‚¹ç»„ä»¶" class="headerlink" title="workder nodeèŠ‚ç‚¹ç»„ä»¶"></a>workder nodeèŠ‚ç‚¹ç»„ä»¶</h4><ul>
<li>kubeletï¼šå‘dockerå‘é€æŒ‡ä»¤ç®¡ç†dockerå®¹å™¨çš„</li>
<li>kube-proxyï¼šç®¡ç†dockerå®¹å™¨çš„ç½‘ç»œ</li>
</ul>
<img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s-2.png">

<img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s-3.png">

<img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s-4.png">

<h4 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h4><p>k8sçš„æ•°æ®åº“ï¼Œç”¨æ¥æ³¨å†ŒèŠ‚ç‚¹ã€æœåŠ¡ã€è®°å½•è´¦æˆ·ä¿¡æ¯â€¦â€¦</p>
<p><font color="red">è¿è¡Œæµç¨‹å›¾</font><br><img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s-1.png"></p>
<h3 id="äºŒã€æ ¸å¿ƒæ¦‚å¿µ"><a href="#äºŒã€æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="äºŒã€æ ¸å¿ƒæ¦‚å¿µ"></a>äºŒã€æ ¸å¿ƒæ¦‚å¿µ</h3><h4 id="pod"><a href="#pod" class="headerlink" title="pod"></a>pod</h4><ul>
<li>podæ˜¯k8sæœ€å°çš„éƒ¨ç½²å•å…ƒ</li>
<li>ä¸€ä¸ªpodä¸­å¯ä»¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ï¼ˆä¸€ç»„å®¹å™¨çš„é›†åˆï¼Œå³å®¹å™¨ç»„ï¼‰</li>
<li>ä¸€ä¸ªpodä¸­çš„å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´</li>
<li>podæ˜¯çŸ­æš‚çš„</li>
</ul>
<h4 id="controllersï¼šæ§åˆ¶å™¨ï¼Œç”¨æ¥æ§åˆ¶podï¼Œå¯åŠ¨ã€åœæ­¢ã€åˆ é™¤"><a href="#controllersï¼šæ§åˆ¶å™¨ï¼Œç”¨æ¥æ§åˆ¶podï¼Œå¯åŠ¨ã€åœæ­¢ã€åˆ é™¤" class="headerlink" title="controllersï¼šæ§åˆ¶å™¨ï¼Œç”¨æ¥æ§åˆ¶podï¼Œå¯åŠ¨ã€åœæ­¢ã€åˆ é™¤"></a>controllersï¼šæ§åˆ¶å™¨ï¼Œç”¨æ¥æ§åˆ¶podï¼Œå¯åŠ¨ã€åœæ­¢ã€åˆ é™¤</h4><ul>
<li>ReplicaSetï¼šç¡®ä¿é¢„æœŸçš„podå‰¯æœ¬æ•°é‡</li>
<li>Deploymentï¼šæ— çŠ¶æ€åº”ç”¨éƒ¨ç½²ï¼ˆç”¨çš„å¤šï¼‰</li>
<li>StatefulSetï¼šæœ‰çŠ¶æ€åº”ç”¨éƒ¨ç½²</li>
<li>DaemonSetï¼šç¡®ä¿æ‰€æœ‰Nodeè¿è¡ŒåŒä¸€ä¸ªPod</li>
<li>Jobï¼šä¸€æ¬¡æ€§ä»»åŠ¡</li>
<li>Cronjobï¼šå®šæ—¶ä»»åŠ¡</li>
</ul>
<h4 id="Serviceï¼šæœåŠ¡"><a href="#Serviceï¼šæœåŠ¡" class="headerlink" title="Serviceï¼šæœåŠ¡"></a>Serviceï¼šæœåŠ¡</h4><p>å°†ä¸€ç»„podå…³è”èµ·æ¥ï¼Œæä¾›ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£ï¼Œå³ä½¿podçš„ç½‘ç»œåœ°å€å‘ç”Ÿæ”¹å˜ï¼Œè¿™ä¸ªç»Ÿä¸€å…¥å£ä¹Ÿä¸ä¼šæ”¹å˜</p>
<ul>
<li>é˜²æ­¢podå¤±è”</li>
<li>å®šä¹‰ä¸€ç»„podçš„è®¿é—®ç­–ç•¥</li>
</ul>
<h4 id="Labelï¼šæ ‡ç­¾"><a href="#Labelï¼šæ ‡ç­¾" class="headerlink" title="Labelï¼šæ ‡ç­¾"></a>Labelï¼šæ ‡ç­¾</h4><p>ä¸€ç»„podæœ‰ä¸€ä¸ªç»Ÿä¸€çš„æ ‡ç­¾ï¼Œserviceé€šè¿‡æ ‡ç­¾å’Œä¸€ç»„podè¿›è¡Œå…³è”</p>
<h4 id="NameSpaceï¼šå‘½åç©ºé—´"><a href="#NameSpaceï¼šå‘½åç©ºé—´" class="headerlink" title="NameSpaceï¼šå‘½åç©ºé—´"></a>NameSpaceï¼šå‘½åç©ºé—´</h4><p>ç”¨æ¥éš”ç¦»podçš„è¿è¡Œç¯å¢ƒã€é»˜è®¤æƒ…å†µä¸‹ï¼Œpodæ˜¯å¯ä»¥äº’ç›¸è®¿é—®çš„ã€‘</p>
<p>ä½¿ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>ä¸ºä¸åŒçš„å…¬å¸æä¾›éš”ç¦»çš„podè¿è¡Œç¯å¢ƒ</li>
<li>ä¸ºå¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒåˆ†åˆ«å‡†å¤‡ä¸åŒçš„åç§°ç©ºé—´ï¼Œè¿›è¡Œéš”ç¦»</li>
</ul>
<h4 id="ä¸ªäººè¡¥å……ï¼ˆçœ‹åˆ°æœ‰æ„ä¹‰çš„å°±ä¼šå†™ï¼‰"><a href="#ä¸ªäººè¡¥å……ï¼ˆçœ‹åˆ°æœ‰æ„ä¹‰çš„å°±ä¼šå†™ï¼‰" class="headerlink" title="ä¸ªäººè¡¥å……ï¼ˆçœ‹åˆ°æœ‰æ„ä¹‰çš„å°±ä¼šå†™ï¼‰"></a>ä¸ªäººè¡¥å……ï¼ˆçœ‹åˆ°æœ‰æ„ä¹‰çš„å°±ä¼šå†™ï¼‰</h4><ol>
<li><p><font color="green"><strong>Kubernetesé‡Œçš„3ç§IP</strong></font></p>
<ul>
<li>Node IPï¼šNodeçš„ipåœ°å€ã€‚Node IPæ˜¯Kubernetesé›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„ç‰©ç†ç½‘å¡çš„IPåœ°å€ï¼Œæ˜¯ä¸€ä¸ªçœŸå®å­˜åœ¨çš„ç‰©ç†ç½‘ç»œï¼Œæ‰€æœ‰å±äºè¿™ä¸ªç½‘ç»œçš„æœåŠ¡å™¨éƒ½èƒ½é€šè¿‡è¿™ä¸ªç½‘ç»œç›´æ¥é€šä¿¡ï¼Œä¸ç®¡å…¶ä¸­æ˜¯å¦æœ‰éƒ¨åˆ†èŠ‚ç‚¹ä¸å±äºè¿™ä¸ªKubernetesé›†ç¾¤ã€‚è¿™ä¹Ÿè¡¨æ˜åœ¨Kubernetesé›†ç¾¤ä¹‹å¤–çš„èŠ‚ç‚¹è®¿é—®Kubernetesé›†ç¾¤ä¹‹å†…çš„æŸä¸ªèŠ‚ç‚¹æˆ–è€…TCP/IPæœåŠ¡æ—¶ï¼Œéƒ½å¿…é¡»é€šè¿‡NodeIPé€šä¿¡ã€‚</li>
<li>Pod IPï¼šPodçš„ipåœ°å€ã€‚Pod IPæ˜¯æ¯ä¸ªPodçš„IPåœ°å€ï¼Œå®ƒæ˜¯Docker Engineæ ¹æ®docker0ç½‘æ¡¥çš„IPåœ°å€æ®µè¿›è¡Œåˆ†é…çš„ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„äºŒå±‚ç½‘ç»œï¼Œå‰é¢è¯´è¿‡ï¼ŒKubernetesè¦æ±‚ä½äºä¸åŒNodeä¸Šçš„Podéƒ½èƒ½å¤Ÿå½¼æ­¤ç›´æ¥é€šä¿¡ï¼Œæ‰€ä»¥Kubernetesé‡Œä¸€ä¸ªPodé‡Œçš„å®¹å™¨è®¿é—®å¦å¤–ä¸€ä¸ªPodé‡Œçš„å®¹å™¨æ—¶ï¼Œå°±æ˜¯é€šè¿‡Pod IPæ‰€åœ¨çš„è™šæ‹ŸäºŒå±‚ç½‘ç»œè¿›è¡Œé€šä¿¡çš„ï¼Œè€ŒçœŸå®çš„TCP/IPæµé‡æ˜¯é€šè¿‡Node IPæ‰€åœ¨çš„ç‰©ç†ç½‘å¡æµå‡ºçš„ã€‚</li>
<li>Cluster IPï¼šServiceçš„ipåœ°å€ã€‚Cluster IPä»…ä»…ä½œç”¨äºKubernetes Serviceè¿™ä¸ªå¯¹è±¡ï¼Œå¹¶ç”±Kubernetesç®¡ç†å’Œåˆ†é…IPåœ°å€ï¼›Cluster IPæ— æ³•è¢«Pingï¼Œå› ä¸ºæ²¡æœ‰ä¸€ä¸ªâ€œå®ä½“ç½‘ç»œå¯¹è±¡â€æ¥å“åº”ï¼›Cluster IPåªèƒ½ç»“åˆService Portç»„æˆä¸€ä¸ªå…·ä½“çš„é€šä¿¡ç«¯å£ï¼Œå•ç‹¬çš„Cluster IPä¸å…·å¤‡TCP/IPé€šä¿¡çš„åŸºç¡€ï¼Œå¹¶ä¸”å®ƒä»¬å±äºKubernetesé›†ç¾¤è¿™æ ·ä¸€ä¸ªå°é—­çš„ç©ºé—´ï¼Œé›†ç¾¤å¤–çš„èŠ‚ç‚¹å¦‚æœè¦è®¿é—®è¿™ä¸ªé€šä¿¡ç«¯å£ï¼Œåˆ™éœ€è¦åšä¸€äº›é¢å¤–çš„å·¥ä½œã€‚</li>
</ul>
</li>
</ol>
<h3 id="ä¸‰ã€æ­å»ºä¸€ä¸ªå®Œæ•´çš„k8sé›†ç¾¤ï¼ˆç¦»çº¿éƒ¨ç½²ï¼‰"><a href="#ä¸‰ã€æ­å»ºä¸€ä¸ªå®Œæ•´çš„k8sé›†ç¾¤ï¼ˆç¦»çº¿éƒ¨ç½²ï¼‰" class="headerlink" title="ä¸‰ã€æ­å»ºä¸€ä¸ªå®Œæ•´çš„k8sé›†ç¾¤ï¼ˆç¦»çº¿éƒ¨ç½²ï¼‰"></a>ä¸‰ã€æ­å»ºä¸€ä¸ªå®Œæ•´çš„k8sé›†ç¾¤ï¼ˆç¦»çº¿éƒ¨ç½²ï¼‰</h3><img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s-5.png">

<h4 id="å•masteré›†ç¾¤"><a href="#å•masteré›†ç¾¤" class="headerlink" title="å•masteré›†ç¾¤"></a>å•masteré›†ç¾¤</h4><img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s-6.png">

<h4 id="å¤šmasteré›†ç¾¤ï¼ˆHAé«˜å¯ç”¨ï¼‰â€”â€”ç”Ÿäº§ç¯å¢ƒ"><a href="#å¤šmasteré›†ç¾¤ï¼ˆHAé«˜å¯ç”¨ï¼‰â€”â€”ç”Ÿäº§ç¯å¢ƒ" class="headerlink" title="å¤šmasteré›†ç¾¤ï¼ˆHAé«˜å¯ç”¨ï¼‰â€”â€”ç”Ÿäº§ç¯å¢ƒ"></a>å¤šmasteré›†ç¾¤ï¼ˆHAé«˜å¯ç”¨ï¼‰â€”â€”ç”Ÿäº§ç¯å¢ƒ</h4><img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s-7.png">

<h4 id="æ¨èé…ç½®"><a href="#æ¨èé…ç½®" class="headerlink" title="æ¨èé…ç½®"></a>æ¨èé…ç½®</h4><img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s-8.png">

<h3 id="å››ã€åˆå§‹åŒ–æœåŠ¡å™¨"><a href="#å››ã€åˆå§‹åŒ–æœåŠ¡å™¨" class="headerlink" title="å››ã€åˆå§‹åŒ–æœåŠ¡å™¨"></a>å››ã€åˆå§‹åŒ–æœåŠ¡å™¨</h3><table>
<thead>
<tr>
<th align="center">è§’è‰²</th>
<th align="center">IP</th>
<th align="center">ç»„ä»¶</th>
</tr>
</thead>
<tbody><tr>
<td align="center">k8s_master1</td>
<td align="center">192.168.18.80</td>
<td align="center">kube-apiserver,kube-controller-manager,kube-scheduler,etcd</td>
</tr>
<tr>
<td align="center">k8s_node1</td>
<td align="center">192.168.18.85</td>
<td align="center">kubelet,kube-proxy,docker,flannel,etcd</td>
</tr>
<tr>
<td align="center">k8s_node2</td>
<td align="center">192.168.18.86</td>
<td align="center">kubelet,kube-proxy,docker,flannel,etcd</td>
</tr>
</tbody></table>
<ul>
<li><p>å…³é—­é˜²ç«å¢™</p>
<ul>
<li>systemctl stop firewalld</li>
<li>systemctl disable firewalld</li>
</ul>
</li>
<li><p>å…³é—­selinux</p>
<ul>
<li>ä¸´æ—¶å…³é—­setenforce 0</li>
<li>vi /etc/selinux/configä¿®æ”¹SELINUX=disabled</li>
</ul>
</li>
<li><p>é…ç½®ä¸»æœºå</p>
<ul>
<li>vi /etc/hostname</li>
</ul>
</li>
<li><p>é…ç½®åç§°è§£æ</p>
<ul>
<li>vi /etc/hostsä¿®æ”¹ip+ä¸»æœºåï¼ˆå¦‚192.168.18.110 dockerï¼‰</li>
</ul>
</li>
<li><p>å…³é—­äº¤æ¢åˆ†åŒº</p>
<ul>
<li>ä¸´æ—¶å…³é—­swapoff -a</li>
<li>vi /etc/fstab åˆ é™¤æœ€åä¸€è¡Œswap</li>
<li>æ£€æŸ¥ï¼šfree -m</li>
</ul>
</li>
<li><p>é…ç½®æ—¶é—´åŒæ­¥</p>
<ul>
<li>æœåŠ¡ç«¯<ul>
<li>yum install chrony -y</li>
<li>vi /etc/chrony.conf</li>
<li>server ntp.sjtu.edu.cn</li>
<li>allow 192.168.18.0/24</li>
<li>local stratum 10</li>
<li>å¯åŠ¨æœåŠ¡ç«¯<ul>
<li>systemctl start chronyd</li>
<li>systemctl enable chronyd</li>
</ul>
</li>
</ul>
</li>
<li>å®¢æˆ·ç«¯<ul>
<li>vi /etc/chrony.conf</li>
<li>server 202.120.2.101 iburst</li>
<li>å¯åŠ¨å®¢æˆ·ç«¯<ul>
<li>systemctl start chronyd</li>
<li>systemctl enable chronyd</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="äº”ã€éƒ¨ç½²etcd"><a href="#äº”ã€éƒ¨ç½²etcd" class="headerlink" title="äº”ã€éƒ¨ç½²etcd"></a>äº”ã€éƒ¨ç½²etcd</h3><h4 id="ç»™etcdé¢å‘è¯ä¹¦"><a href="#ç»™etcdé¢å‘è¯ä¹¦" class="headerlink" title="ç»™etcdé¢å‘è¯ä¹¦"></a>ç»™etcdé¢å‘è¯ä¹¦</h4><ul>
<li>åˆ›å»ºè¯ä¹¦é¢å‘æœºæ„</li>
<li>å¡«å†™è¡¨å•â€“å†™æ˜etcdæ‰€åœ¨èŠ‚ç‚¹çš„ip</li>
<li>å‘è¯ä¹¦é¢å‘æœºæ„ç”³è¯·è¯ä¹¦</li>
</ul>
<h4 id="ä¸‹è½½cfsslå·¥å…·"><a href="#ä¸‹è½½cfsslå·¥å…·" class="headerlink" title="ä¸‹è½½cfsslå·¥å…·"></a>ä¸‹è½½cfsslå·¥å…·</h4><p>(åœ¨/home/etcdä¸‹)ä½¿ç”¨cfsslæ¥ç”Ÿæˆè‡ªç­¾è¯ä¹¦ï¼Œå…ˆä¸‹è½½cfsslå·¥å…·ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line"><span class="meta">#</span> wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line"><span class="meta">#</span> wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line"><span class="meta">#</span> chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span><br><span class="line"><span class="meta">#</span> mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line"><span class="meta">#</span> mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line"><span class="meta">#</span> mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</span><br></pre></td></tr></table></figure>

<h4 id="ç”Ÿæˆè¯ä¹¦-ç¼–å†™ä¸‰ä¸ªjsonæ–‡ä»¶"><a href="#ç”Ÿæˆè¯ä¹¦-ç¼–å†™ä¸‰ä¸ªjsonæ–‡ä»¶" class="headerlink" title="ç”Ÿæˆè¯ä¹¦:ç¼–å†™ä¸‰ä¸ªjsonæ–‡ä»¶"></a>ç”Ÿæˆè¯ä¹¦:ç¼–å†™ä¸‰ä¸ªjsonæ–‡ä»¶</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æˆ‘çš„ä½ç½®åœ¨/home/etcdä¸‹ï¼Œä¸‰ä¸ªjsonæ–‡ä»¶åˆ›å»º</span></span><br><span class="line"><span class="comment"># cat ca-config.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">  "signing":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "default":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">      "expiry":</span> <span class="string">"87600h"</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">    "profiles":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">      "www":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">         "expiry":</span> <span class="string">"87600h"</span><span class="string">,</span></span><br><span class="line"><span class="attr">         "usages":</span> <span class="string">[</span></span><br><span class="line">            <span class="string">"signing"</span><span class="string">,</span></span><br><span class="line">            <span class="string">"key encipherment"</span><span class="string">,</span></span><br><span class="line">            <span class="string">"server auth"</span><span class="string">,</span></span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        <span class="string">]</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat ca-csr.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "CN":</span> <span class="string">"etcd CA"</span><span class="string">,</span></span><br><span class="line"><span class="attr">    "key":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">        "algo":</span> <span class="string">"rsa"</span><span class="string">,</span></span><br><span class="line"><span class="attr">        "size":</span> <span class="number">2048</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">    "names":</span> <span class="string">[</span></span><br><span class="line">        <span class="string">&#123;</span></span><br><span class="line"><span class="attr">            "C":</span> <span class="string">"CN"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "L":</span> <span class="string">"Beijing"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "ST":</span> <span class="string">"Beijing"</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat server-csr.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "CN":</span> <span class="string">"etcd"</span><span class="string">,</span></span><br><span class="line"><span class="attr">    "hosts":</span> <span class="string">[</span></span><br><span class="line">    <span class="string">"192.168.18.80"</span><span class="string">,</span></span><br><span class="line">    <span class="string">"192.168.18.85"</span><span class="string">,</span></span><br><span class="line">    <span class="string">"192.168.18.86"</span></span><br><span class="line">    <span class="string">],</span></span><br><span class="line"><span class="attr">    "key":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">        "algo":</span> <span class="string">"rsa"</span><span class="string">,</span></span><br><span class="line"><span class="attr">        "size":</span> <span class="number">2048</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">    "names":</span> <span class="string">[</span></span><br><span class="line">        <span class="string">&#123;</span></span><br><span class="line"><span class="attr">            "C":</span> <span class="string">"CN"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "L":</span> <span class="string">"BeiJing"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "ST":</span> <span class="string">"BeiJing"</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">]</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>ç”Ÿæˆè¯ä¹¦å‘½ä»¤è¡Œ</span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server</span><br><span class="line"><span class="meta">#</span> ls *pemï¼ˆåº”è¯¥æœ‰4ä¸ªpemç»“å°¾çš„æ–‡ä»¶ï¼‰</span><br><span class="line">ca-key.pem  ca.pem  server-key.pem  server.pem</span><br></pre></td></tr></table></figure>

<h4 id="éƒ¨ç½²etcd"><a href="#éƒ¨ç½²etcd" class="headerlink" title="éƒ¨ç½²etcd"></a>éƒ¨ç½²etcd</h4><p>è¿™é‡Œä½¿ç”¨çš„æ˜¯äºŒè¿›åˆ¶éƒ¨ç½²ï¼Œä¸æƒ³ç”¨å…¶ä»–çš„æ–¹æ³•ã€‚</p>
<p>äºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/coreos/etcd/releases/" target="_blank" rel="noopener">https://github.com/coreos/etcd/releases/</a></p>
<p><strong>æœ‰etcdçš„nodeä¸Šéƒ½è¦éƒ¨ç½²ï¼Œæ³¨æ„æ–‡ä»¶å¤¹çš„åå­—å’Œä½ç½®ï¼Œä¸æ˜¯éšä¾¿å‘½åå’Œæ”¾ç½®çš„</strong>ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>è§£å‹å‹ç¼©åŒ…</span><br><span class="line">mkdir /opt/etcd/&#123;bin,cfg,ssl&#125; -p</span><br><span class="line">tar -zxvf etcd-v3.2.12-linux-amd64.tar.gz -C ./</span><br><span class="line">mv etcd-v3.2.12-linux-amd64/&#123;etcd,etcdctl&#125; /opt/etcd/bin/</span><br></pre></td></tr></table></figure>

<p><font color="orange">åˆ›å»ºetcdé…ç½®æ–‡ä»¶</font></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># touch etcd</span></span><br><span class="line"><span class="comment"># chmod 777 etcd</span></span><br><span class="line"><span class="comment"># cat /opt/etcd/cfg/etcd   </span></span><br><span class="line"><span class="comment">#[Member]</span></span><br><span class="line"><span class="string">ETCD_NAME="k8s_master1"</span></span><br><span class="line"><span class="string">ETCD_DATA_DIR="/var/lib/etcd/default.etcd"</span></span><br><span class="line"><span class="string">ETCD_LISTEN_PEER_URLS="https://192.168.18.80:2380"</span></span><br><span class="line"><span class="string">ETCD_LISTEN_CLIENT_URLS="https://192.168.18.80:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line"><span class="string">ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.18.80:2380"</span></span><br><span class="line"><span class="string">ETCD_ADVERTISE_CLIENT_URLS="https://192.168.18.80:2379"</span></span><br><span class="line"><span class="string">ETCD_INITIAL_CLUSTER="etcd01=https://192.168.18.80:2380,k8s_node1=https://192.168.18.85:2380,k8s_node2=https://192.168.18.86:2380"</span></span><br><span class="line"><span class="string">ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"</span></span><br><span class="line"><span class="string">ETCD_INITIAL_CLUSTER_STATE="new"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------------------è§£é‡Š-------------------------------------------</span></span><br><span class="line"><span class="comment">#ETCD_NAME èŠ‚ç‚¹åç§°</span></span><br><span class="line"><span class="comment">#ETCD_DATA_DIR æ•°æ®ç›®å½•</span></span><br><span class="line"><span class="comment">#ETCD_LISTEN_PEER_URLS é›†ç¾¤é€šä¿¡ç›‘å¬åœ°å€</span></span><br><span class="line"><span class="comment">#ETCD_LISTEN_CLIENT_URLS å®¢æˆ·ç«¯è®¿é—®ç›‘å¬åœ°å€</span></span><br><span class="line"><span class="comment">#ETCD_INITIAL_ADVERTISE_PEER_URLS é›†ç¾¤é€šå‘Šåœ°å€</span></span><br><span class="line"><span class="comment">#ETCD_ADVERTISE_CLIENT_URLS å®¢æˆ·ç«¯é€šå‘Šåœ°å€</span></span><br><span class="line"><span class="comment">#ETCD_INITIAL_CLUSTER é›†ç¾¤èŠ‚ç‚¹åœ°å€</span></span><br><span class="line"><span class="comment">#ETCD_INITIAL_CLUSTER_TOKEN é›†ç¾¤Token</span></span><br><span class="line"><span class="comment">#ETCD_INITIAL_CLUSTER_STATE åŠ å…¥é›†ç¾¤çš„å½“å‰çŠ¶æ€ï¼Œnewæ˜¯æ–°é›†ç¾¤ï¼Œexistingè¡¨ç¤ºåŠ å…¥å·²æœ‰é›†ç¾¤</span></span><br></pre></td></tr></table></figure>

<p><font color="orange">systemdç®¡ç†etcd</font></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># touch /usr/lib/systemd/system/etcd.service</span></span><br><span class="line"><span class="comment"># cat /usr/lib/systemd/system/etcd.service </span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Etcd</span> <span class="string">Server</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string">After=network-online.target</span></span><br><span class="line"><span class="string">Wants=network-online.target</span></span><br><span class="line"></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">EnvironmentFile=/opt/etcd/cfg/etcd</span></span><br><span class="line"><span class="string">ExecStart=/opt/etcd/bin/etcd</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-name=$&#123;ETCD_NAME&#125;</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-data-dir=$&#123;ETCD_DATA_DIR&#125;</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-listen-peer-urls=$&#123;ETCD_LISTEN_PEER_URLS&#125;</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-listen-client-urls=$&#123;ETCD_LISTEN_CLIENT_URLS&#125;,http://127.0.0.1:2379</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-advertise-client-urls=$&#123;ETCD_ADVERTISE_CLIENT_URLS&#125;</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-initial-advertise-peer-urls=$&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125;</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-initial-cluster=$&#123;ETCD_INITIAL_CLUSTER&#125;</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-initial-cluster-token=$&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125;</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-initial-cluster-state=new</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-cert-file=/opt/etcd/ssl/server.pem</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-key-file=/opt/etcd/ssl/server-key.pem</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-peer-cert-file=/opt/etcd/ssl/server.pem</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-peer-key-file=/opt/etcd/ssl/server-key.pem</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-trusted-ca-file=/opt/etcd/ssl/ca.pem</span> <span class="string">\</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-peer-trusted-ca-file=/opt/etcd/ssl/ca.pem</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">LimitNOFILE=65536</span></span><br><span class="line"></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br></pre></td></tr></table></figure>

<p><font color="orange">å°†ä¹‹å‰ç”Ÿæˆçš„è¯ä¹¦æ‹·è´åˆ°å›ºå®šçš„ç›®å½•</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ca*pem server*pem /opt/etcd/ssl</span><br></pre></td></tr></table></figure>

<p><font color="orange">å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start etcd</span><br><span class="line">systemctl enable etcd</span><br></pre></td></tr></table></figure>

<p><font color="red">æ³¨æ„ï¼šä»¥ä¸Šæ­¥éª¤éœ€è¦åœ¨æ‰€æœ‰è¦å®‰è£…etcdçš„nodeä¸Šæ‰§è¡Œä¸€æ¬¡ï¼Œä¸æ˜¯åªåœ¨master nodeä¸Šæ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡scpå‘½ä»¤å‘é€åˆ°å…¶ä»–nodeï¼Œéœ€è¦æ”¹ä¸€ä¸‹etcdçš„é…ç½®æ–‡ä»¶ï¼ŒèŠ‚ç‚¹åå’ŒèŠ‚ç‚¹ipã€‚</font></p>
<p><font color="orange">åœ¨éƒ½éƒ¨ç½²å®Œæˆåï¼Œæ£€æŸ¥ä¸€ä¸‹é›†ç¾¤çš„çŠ¶æ€(è‹¥æ˜¯å‡ºç°cluster is healthyï¼Œè¯´æ˜éƒ¨ç½²æˆåŠŸï¼)</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s_master1 cfg]# /opt/etcd/bin/etcdctl --ca-file=/opt/etcd/ssl/ca.pem --cert-file=/opt/etcd/ssl/server.pem --key-file=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.18.80:2379,https://192.168.18.85:2379,https://192.168.18.86:2379&quot; cluster-health</span><br><span class="line">member feb9f9de26a0d6d is healthy: got healthy result from https://192.168.18.80:2379</span><br><span class="line">member 94c59c0ee7401835 is healthy: got healthy result from https://192.168.18.85:2379</span><br><span class="line">member a5106f019eb73cbd is healthy: got healthy result from https://192.168.18.86:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure>

<h3 id="å…­ã€å®‰è£…docker"><a href="#å…­ã€å®‰è£…docker" class="headerlink" title="å…­ã€å®‰è£…docker"></a>å…­ã€å®‰è£…docker</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"># wget -O CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"># yum install docker-ce -y</span><br><span class="line"># systemctl start docker</span><br><span class="line"># systemctl enable docker</span><br></pre></td></tr></table></figure>

<h3 id="ä¸ƒã€éƒ¨ç½²Flannelç½‘ç»œ"><a href="#ä¸ƒã€éƒ¨ç½²Flannelç½‘ç»œ" class="headerlink" title="ä¸ƒã€éƒ¨ç½²Flannelç½‘ç»œ"></a>ä¸ƒã€éƒ¨ç½²Flannelç½‘ç»œ</h3><p><strong>å·¥ä½œåŸç†ï¼š</strong></p>
<img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/flannel.png">

<p><strong>Flannelè¦ç”¨etcdå­˜å‚¨è‡ªèº«ä¸€ä¸ªå­ç½‘ä¿¡æ¯ï¼Œè¦ä¿è¯èƒ½æˆåŠŸè¿æ¥etcdï¼Œå†™å…¥é¢„å®šä¹‰å­ç½‘æ®µ</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#------------------æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰åœ¨masterèŠ‚ç‚¹ä¸Šéƒ¨ç½²flannel--------------------</span><br><span class="line"># /opt/etcd/bin/etcdctl \</span><br><span class="line">--ca-file=ca.pem --cert-file=server.pem --key-file=server-key.pem \</span><br><span class="line">--endpoints=&quot;https://192.168.18.85:2379,https://192.168.18.86:2379&quot; \</span><br><span class="line">set /coreos.com/network/config  &apos;&#123; &quot;Network&quot;: &quot;172.17.76.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;&apos;</span><br><span class="line"></span><br><span class="line">#-------------------------------------------------------------------------</span><br><span class="line">#è®¾ç½®å®Œæˆåå¯ä»¥é€šè¿‡ä»¥ä¸‹æŸ¥çœ‹</span><br><span class="line"># /opt/etcd/bin/etcdctl \</span><br><span class="line">--ca-file=ca.pem --cert-file=server.pem --key-file=server-key.pem \</span><br><span class="line">--endpoints=&quot;https://192.168.18.85:2379,https://192.168.18.86:2379&quot; \</span><br><span class="line">get /coreos.com/network/config</span><br></pre></td></tr></table></figure>

<p><strong>ä»¥ä¸‹çš„æ­¥éª¤éœ€è¦åœ¨æ¯ä¸ªéƒ¨ç½²flannelçš„èŠ‚ç‚¹ä¸Šæ“ä½œ</strong></p>
<p><font color="orange">ä¸‹è½½äºŒè¿›åˆ¶åŒ…</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># wget https://github.com/coreos/flannel/releases/download/v0.10.0/flannel-v0.10.0-linux-amd64.tar.gz</span><br><span class="line"># tar -zxvf flannel-v0.9.1-linux-amd64.tar.gz -C ./</span><br><span class="line"># mv flanneld mk-docker-opts.sh /opt/kubernetes/bin</span><br></pre></td></tr></table></figure>

<p><font color="orange">é…ç½®Flannel</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cat /opt/kubernetes/cfg/flanneld</span><br><span class="line">FLANNEL_OPTIONS=&quot;--etcd-endpoints=https://192.168.18.85:2379,https://192.168.18.86:2379 -etcd-cafile=/opt/etcd/ssl/ca.pem -etcd-certfile=/opt/etcd/ssl/server.pem -etcd-keyfile=/opt/etcd/ssl/server-key.pem&quot;</span><br></pre></td></tr></table></figure>

<p><font color="orange">systemdç®¡ç†Flannel</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># cat /usr/lib/systemd/system/flanneld.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network-online.target network.target</span><br><span class="line">Before=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/flanneld</span><br><span class="line">ExecStart=/opt/kubernetes/bin/flanneld --ip-masq $FLANNEL_OPTIONS</span><br><span class="line">ExecStartPost=/opt/kubernetes/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/subnet.env</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><font color="orange">é…ç½®Dockerå¯åŠ¨æŒ‡å®šå­ç½‘æ®µ</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># cat /usr/lib/systemd/system/docker.service </span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/run/flannel/subnet.env</span><br><span class="line">ExecStart=/usr/bin/dockerd $DOCKER_NETWORK_OPTIONS</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><font color="orange">é‡å¯Flannelå’ŒDocker</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># systemctl daemon-reload</span><br><span class="line"># systemctl start flanneld</span><br><span class="line"># systemctl enable flanneld</span><br><span class="line"># systemctl restart docker</span><br></pre></td></tr></table></figure>

<p><font color="orange">æ£€æŸ¥æ˜¯å¦æˆåŠŸ(bip=172.17.74.1)</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s_node2 ~]# ps -ef | grep docker</span><br><span class="line">root        2958       1  0 05:11 ?        00:00:14 /usr/bin/dockerd-current --bip=172.17.74.1/24 --ip-masq=false --mtu=1450</span><br><span class="line">root        2964    2958  0 05:11 ?        00:00:09 /usr/bin/docker-containerd-current -l unix:///var/run/docker/libcontainerd/docker-containerd.sock --metrics-interval=0 --start-timeout 2m --state-dir /var/run/docker/libcontainerd/containerd --shim docker-containerd-shim --runtime docker-runc</span><br><span class="line">root       11400    1776  0 06:46 pts/0    00:00:00 grep --color=auto docker</span><br><span class="line"></span><br><span class="line">#--------------------------------------------------------------------------------</span><br><span class="line">#ifconfig</span><br><span class="line">docker0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.17.74.1  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">flannel.1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">        inet 172.17.74.0  netmask 255.255.255.255  broadcast 0.0.0.0</span><br></pre></td></tr></table></figure>

<p><font color="red">ç¡®ä¿docker0ä¸flannel.1åœ¨åŒä¸€ä¸ªç½‘æ®µ</font></p>
<p><font color="orange">ä¸ºäº†æµ‹è¯•ä¸åŒnodeä¹‹é—´äº’é€šï¼Œåœ¨ä»»æ„ä¸€ä¸ªnodeä¸Špingå¦ä¸€ä¸ªnodeçš„docker0çš„ip</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">##### k8s_node1â€”â€”&gt;172.17.74.0/16 #####</span><br><span class="line">##### k8s_node2â€”â€”&gt;172.17.76.0/16 #####</span><br><span class="line"></span><br><span class="line">[root@k8s_node2 ~]# ping 172.17.76.0</span><br><span class="line">PING 172.17.76.0 (172.17.76.0) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.76.0: icmp_seq=1 ttl=64 time=0.973 ms</span><br><span class="line">64 bytes from 172.17.76.0: icmp_seq=2 ttl=64 time=0.264 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.17.76.0 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span><br><span class="line">rtt min/avg/max/mdev = 0.264/0.618/0.973/0.355 ms</span><br><span class="line">[root@k8s_node2 ~]# ping 172.17.76.1</span><br><span class="line">PING 172.17.76.1 (172.17.76.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.76.1: icmp_seq=1 ttl=64 time=0.389 ms</span><br><span class="line">64 bytes from 172.17.76.1: icmp_seq=2 ttl=64 time=0.447 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.17.76.1 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span><br><span class="line">rtt min/avg/max/mdev = 0.389/0.418/0.447/0.029 ms</span><br><span class="line">[root@k8s_node2 ~]# ping 172.17.74.0</span><br><span class="line">PING 172.17.74.0 (172.17.74.0) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.74.0: icmp_seq=1 ttl=64 time=0.125 ms</span><br><span class="line">64 bytes from 172.17.74.0: icmp_seq=2 ttl=64 time=0.043 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.17.74.0 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 999ms</span><br><span class="line">rtt min/avg/max/mdev = 0.043/0.084/0.125/0.041 ms</span><br><span class="line">[root@k8s_node2 ~]# ping 172.17.74.1</span><br><span class="line">PING 172.17.74.1 (172.17.74.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.74.1: icmp_seq=1 ttl=64 time=0.090 ms</span><br><span class="line">64 bytes from 172.17.74.1: icmp_seq=2 ttl=64 time=0.031 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.17.74.1 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1000ms</span><br><span class="line">rtt min/avg/max/mdev = 0.031/0.060/0.090/0.030 ms</span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœä½ éƒ½æ²¡æœ‰é—®é¢˜ï¼Œåˆ™è¯´æ˜Flanneléƒ¨ç½²æˆåŠŸï¼</strong></p>
<p><font color="green">ä¸€äº›ç»†èŠ‚</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s_master1 cfg]# tree /opt/etcd/</span><br><span class="line">/opt/etcd/</span><br><span class="line">â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ etcd</span><br><span class="line">â”‚Â Â  â””â”€â”€ etcdctl</span><br><span class="line">â”œâ”€â”€ cfg</span><br><span class="line">â”‚Â Â  â””â”€â”€ etcd</span><br><span class="line">â””â”€â”€ ssl</span><br><span class="line">    â”œâ”€â”€ ca.pem</span><br><span class="line">    â”œâ”€â”€ server-key.pem</span><br><span class="line">    â””â”€â”€ server.pem</span><br><span class="line"></span><br><span class="line">[root@k8s_master1 cfg]# tree /opt/kubernetes/</span><br><span class="line">/opt/kubernetes/</span><br><span class="line">â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ flanneld</span><br><span class="line">â”‚Â Â  â””â”€â”€ mk-docker-opts.sh</span><br><span class="line">â”œâ”€â”€ cfg</span><br><span class="line">â”‚Â Â  â””â”€â”€ flanneld</span><br><span class="line">â””â”€â”€ ssl</span><br><span class="line"></span><br><span class="line">[root@k8s_master1 wangzichen]# tree /home/etcd</span><br><span class="line">/home/etcd</span><br><span class="line">â”œâ”€â”€ ca-config.json</span><br><span class="line">â”œâ”€â”€ ca-.csr</span><br><span class="line">â”œâ”€â”€ ca.csr</span><br><span class="line">â”œâ”€â”€ ca-csr.json</span><br><span class="line">â”œâ”€â”€ ca-key.pem</span><br><span class="line">â”œâ”€â”€ ca.pem</span><br><span class="line">â”œâ”€â”€ generate_etcd_cert.sh</span><br><span class="line">â”œâ”€â”€ server.csr</span><br><span class="line">â”œâ”€â”€ server-csr.json</span><br><span class="line">â”œâ”€â”€ server-key.pem</span><br><span class="line">â””â”€â”€ server.pem</span><br><span class="line"></span><br><span class="line">#----------------------------------------------------------------------------------</span><br><span class="line">[root@k8s_node1 opt]# tree etcd/</span><br><span class="line">etcd/</span><br><span class="line">â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ etcd</span><br><span class="line">â”‚Â Â  â””â”€â”€ etcdctl</span><br><span class="line">â”œâ”€â”€ cfg</span><br><span class="line">â”‚Â Â  â””â”€â”€ etcd</span><br><span class="line">â””â”€â”€ ssl</span><br><span class="line">    â”œâ”€â”€ ca.pem</span><br><span class="line">    â”œâ”€â”€ server-key.pem</span><br><span class="line">    â””â”€â”€ server.pem</span><br><span class="line"></span><br><span class="line">[root@k8s_node1 opt]# tree kubernetes/</span><br><span class="line">kubernetes/</span><br><span class="line">â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ flanneld</span><br><span class="line">â”‚Â Â  â””â”€â”€ mk-docker-opts.sh</span><br><span class="line">â”œâ”€â”€ cfg</span><br><span class="line">â”‚Â Â  â””â”€â”€ flanneld</span><br><span class="line">â””â”€â”€ ssl</span><br><span class="line"></span><br><span class="line">#----------------------------------------------------------------------------------</span><br><span class="line">[root@k8s_node2 ~]# tree /opt/etcd/</span><br><span class="line">/opt/etcd/</span><br><span class="line">â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ etcd</span><br><span class="line">â”‚Â Â  â””â”€â”€ etcdctl</span><br><span class="line">â”œâ”€â”€ cfg</span><br><span class="line">â”‚Â Â  â””â”€â”€ etcd</span><br><span class="line">â””â”€â”€ ssl</span><br><span class="line">    â”œâ”€â”€ ca.pem</span><br><span class="line">    â”œâ”€â”€ server-key.pem</span><br><span class="line">    â””â”€â”€ server.pem</span><br><span class="line"></span><br><span class="line">[root@k8s_node2 ~]# tree /opt/kubernetes/</span><br><span class="line">/opt/kubernetes/</span><br><span class="line">â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ flanneld</span><br><span class="line">â”‚Â Â  â””â”€â”€ mk-docker-opts.sh</span><br><span class="line">â”œâ”€â”€ cfg</span><br><span class="line">â”‚Â Â  â””â”€â”€ flanneld</span><br><span class="line">â””â”€â”€ ssl</span><br></pre></td></tr></table></figure>

<h3 id="å…«ã€MasterèŠ‚ç‚¹éƒ¨ç½²ç»„ä»¶"><a href="#å…«ã€MasterèŠ‚ç‚¹éƒ¨ç½²ç»„ä»¶" class="headerlink" title="å…«ã€MasterèŠ‚ç‚¹éƒ¨ç½²ç»„ä»¶"></a>å…«ã€MasterèŠ‚ç‚¹éƒ¨ç½²ç»„ä»¶</h3><p>åœ¨éƒ¨ç½²Kubernetesä¹‹å‰ä¸€å®šè¦ä¿è¯etcdï¼Œflannelï¼Œdockeræ˜¯æ­£å¸¸å·¥ä½œçš„ã€‚</p>
<h4 id="ç”Ÿæˆè¯ä¹¦ï¼ˆå’Œetcdè¯ä¹¦ä¸åŒï¼‰"><a href="#ç”Ÿæˆè¯ä¹¦ï¼ˆå’Œetcdè¯ä¹¦ä¸åŒï¼‰" class="headerlink" title="ç”Ÿæˆè¯ä¹¦ï¼ˆå’Œetcdè¯ä¹¦ä¸åŒï¼‰"></a>ç”Ÿæˆè¯ä¹¦ï¼ˆå’Œetcdè¯ä¹¦ä¸åŒï¼‰</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd /home/k8såœ¨æ­¤ç›®å½•ä¸‹åˆ›å»ºjsonæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># cat ca-config.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">  "signing":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "default":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">      "expiry":</span> <span class="string">"87600h"</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">    "profiles":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">      "kubernetes":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">         "expiry":</span> <span class="string">"87600h"</span><span class="string">,</span></span><br><span class="line"><span class="attr">         "usages":</span> <span class="string">[</span></span><br><span class="line">            <span class="string">"signing"</span><span class="string">,</span></span><br><span class="line">            <span class="string">"key encipherment"</span><span class="string">,</span></span><br><span class="line">            <span class="string">"server auth"</span><span class="string">,</span></span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        <span class="string">]</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat ca-csr.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "CN":</span> <span class="string">"kubernetes"</span><span class="string">,</span></span><br><span class="line"><span class="attr">    "key":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">        "algo":</span> <span class="string">"rsa"</span><span class="string">,</span></span><br><span class="line"><span class="attr">        "size":</span> <span class="number">2048</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">    "names":</span> <span class="string">[</span></span><br><span class="line">        <span class="string">&#123;</span></span><br><span class="line"><span class="attr">            "C":</span> <span class="string">"CN"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "L":</span> <span class="string">"Beijing"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "ST":</span> <span class="string">"Beijing"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "O":</span> <span class="string">"k8s"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "OU":</span> <span class="string">"System"</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆapiserverè¯ä¹¦</span></span><br><span class="line"><span class="comment"># cat server-csr.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "CN":</span> <span class="string">"kubernetes"</span><span class="string">,</span></span><br><span class="line"><span class="attr">    "hosts":</span> <span class="string">[</span></span><br><span class="line">      <span class="string">"10.0.0.1"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"127.0.0.1"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"192.168.18.80"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"kubernetes"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"kubernetes.default"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"kubernetes.default.svc"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"kubernetes.default.svc.cluster"</span><span class="string">,</span></span><br><span class="line">      <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">    <span class="string">],</span></span><br><span class="line"><span class="attr">    "key":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">        "algo":</span> <span class="string">"rsa"</span><span class="string">,</span></span><br><span class="line"><span class="attr">        "size":</span> <span class="number">2048</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">    "names":</span> <span class="string">[</span></span><br><span class="line">        <span class="string">&#123;</span></span><br><span class="line"><span class="attr">            "C":</span> <span class="string">"CN"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "L":</span> <span class="string">"BeiJing"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "ST":</span> <span class="string">"BeiJing"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "O":</span> <span class="string">"k8s"</span><span class="string">,</span></span><br><span class="line"><span class="attr">            "OU":</span> <span class="string">"System"</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="comment">#cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># ç”Ÿæˆkube-proxyè¯ä¹¦</span></span><br><span class="line"><span class="comment"># cat kube-proxy-csr.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">  "CN":</span> <span class="string">"system:kube-proxy"</span><span class="string">,</span></span><br><span class="line"><span class="attr">  "hosts":</span> <span class="string">[],</span></span><br><span class="line"><span class="attr">  "key":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "algo":</span> <span class="string">"rsa"</span><span class="string">,</span></span><br><span class="line"><span class="attr">    "size":</span> <span class="number">2048</span></span><br><span class="line">  <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">  "names":</span> <span class="string">[</span></span><br><span class="line">    <span class="string">&#123;</span></span><br><span class="line"><span class="attr">      "C":</span> <span class="string">"CN"</span><span class="string">,</span></span><br><span class="line"><span class="attr">      "L":</span> <span class="string">"BeiJing"</span><span class="string">,</span></span><br><span class="line"><span class="attr">      "ST":</span> <span class="string">"BeiJing"</span><span class="string">,</span></span><br><span class="line"><span class="attr">      "O":</span> <span class="string">"k8s"</span><span class="string">,</span></span><br><span class="line"><span class="attr">      "OU":</span> <span class="string">"System"</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">  <span class="string">]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># æ¯ä¸ªåˆ›å»ºjsonæ–‡ä»¶åï¼Œåœ¨å‘½ä»¤è¡Œæ‰§è¡Œæ¯ä¸ªåé¢çš„å‘½ä»¤</span></span><br><span class="line"><span class="string">[root@k8s_master1</span> <span class="string">k8s]#</span> <span class="string">ll</span></span><br><span class="line"><span class="string">total</span> <span class="number">72</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-------</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">2167</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">22</span><span class="string">:05</span> <span class="string">bootstrap.kubeconfig</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">294</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:43</span> <span class="string">ca-config.json</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1001</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:43</span> <span class="string">ca.csr</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">265</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:43</span> <span class="string">ca-csr.json</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-------</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1679</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:43</span> <span class="string">ca-key.pem</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1359</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:43</span> <span class="string">ca.pem</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1870</span> <span class="string">Apr</span>  <span class="number">9</span> <span class="number">19</span><span class="string">:11</span> <span class="string">etcd.sh</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1009</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:44</span> <span class="string">kube-proxy.csr</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">230</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:44</span> <span class="string">kube-proxy-csr.json</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-------</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1675</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:44</span> <span class="string">kube-proxy-key.pem</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-------</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">6269</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">22</span><span class="string">:05</span> <span class="string">kube-proxy.kubeconfig</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1403</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:44</span> <span class="string">kube-proxy.pem</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rwxrwxrwx</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1329</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">22</span><span class="string">:05</span> <span class="string">kubernetes.sh</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1245</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:44</span> <span class="string">server.csr</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">511</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:44</span> <span class="string">server-csr.json</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-------</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1675</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:44</span> <span class="string">server-key.pem</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">1610</span> <span class="string">Apr</span> <span class="number">10</span> <span class="number">19</span><span class="string">:44</span> <span class="string">server.pem</span></span><br><span class="line"><span class="comment"># ä¼šæœ‰6ä¸ªä»¥pemç»“å°¾çš„æ–‡ä»¶ï¼Œåˆ™æˆåŠŸ</span></span><br></pre></td></tr></table></figure>

<h4 id="éƒ¨ç½²apiserverç»„ä»¶"><a href="#éƒ¨ç½²apiserverç»„ä»¶" class="headerlink" title="éƒ¨ç½²apiserverç»„ä»¶"></a>éƒ¨ç½²apiserverç»„ä»¶</h4><p>ä¸‹è½½äºŒè¿›åˆ¶åŒ…<a href="https://pan.baidu.com/s/1B_rbab9t6ufY7daSpeuQTg" target="_blank" rel="noopener">é™„ç™¾åº¦äº‘é“¾æ¥</a>ï¼Œé‡Œé¢æœ‰3ä¸ªç‰ˆæœ¬ï¼Œç›´æ¥æ‰¾<strong>kubernetes-server-linux-amd64.tar.gz</strong>å³å¯ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> mkdir /opt/kubernetes/&#123;bin,cfg,ssl&#125; -p</span><br><span class="line"><span class="meta">#</span> tar -zxvf kubernetes-server-linux-amd64.tar.gz ./</span><br><span class="line"><span class="meta">#</span> cd kubernetes/server/bin</span><br><span class="line"><span class="meta">#</span> cp kube-apiserver kube-scheduler kube-controller-manager kubectl /opt/kubernetes/bin</span><br></pre></td></tr></table></figure>

<p><font color="orange">åˆ›å»ºtokenæ–‡ä»¶ï¼Œç”¨é€”ä¹‹åä¼šæœ‰ç”¨åˆ°</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /opt/kubernetes/cfg/token.csv</span><br><span class="line">674c457d4dcf2eefe4920d7dbb6b0ddc,</span><br><span class="line">kubelet-bootstrap,</span><br><span class="line">10001,</span><br><span class="line">"system:kubelet-bootstrap"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>ç¬¬ä¸€åˆ—ï¼šéšæœºå­—ç¬¦ä¸²ï¼Œè‡ªå·±å¯ç”Ÿæˆ</span><br><span class="line"><span class="meta">#</span>ç¬¬äºŒåˆ—ï¼šç”¨æˆ·å</span><br><span class="line"><span class="meta">#</span>ç¬¬ä¸‰åˆ—ï¼šUID</span><br><span class="line"><span class="meta">#</span>ç¬¬å››åˆ—ï¼šç”¨æˆ·ç»„</span><br></pre></td></tr></table></figure>

<p><font color="orange">åˆ›å»ºapiserveré…ç½®æ–‡ä»¶</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /opt/kubernetes/cfg/kube-apiserver </span><br><span class="line"></span><br><span class="line">KUBE_APISERVER_OPTS="--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--etcd-servers=https://192.168.18.80:2379,https://192.168.18.85:2379,https://192.168.18.86:2379 \</span><br><span class="line">--bind-address=192.168.18.80 \</span><br><span class="line">--secure-port=6443 \</span><br><span class="line">--advertise-address=192.168.18.80 \</span><br><span class="line">--allow-privileged=true \</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota,NodeRestriction \</span><br><span class="line">--authorization-mode=RBAC,Node \</span><br><span class="line">--enable-bootstrap-token-auth \</span><br><span class="line">--token-auth-file=/opt/kubernetes/cfg/token.csv \</span><br><span class="line">--service-node-port-range=30000-50000 \</span><br><span class="line">--tls-cert-file=/opt/kubernetes/ssl/server.pem  \</span><br><span class="line">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \</span><br><span class="line">--client-ca-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \</span><br><span class="line">--etcd-cafile=/opt/etcd/ssl/ca.pem \</span><br><span class="line">--etcd-certfile=/opt/etcd/ssl/server.pem \</span><br><span class="line">--etcd-keyfile=/opt/etcd/ssl/server-key.pem"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>---------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">å‚æ•°è¯´æ˜ï¼š</span><br><span class="line">â€“logtostderr å¯ç”¨æ—¥å¿—</span><br><span class="line">â€”v æ—¥å¿—ç­‰çº§</span><br><span class="line">â€“etcd-servers etcdé›†ç¾¤åœ°å€</span><br><span class="line">â€“bind-address ç›‘å¬åœ°å€</span><br><span class="line">â€“secure-port httpså®‰å…¨ç«¯å£</span><br><span class="line">â€“advertise-address é›†ç¾¤é€šå‘Šåœ°å€</span><br><span class="line">â€“allow-privileged å¯ç”¨æˆæƒ</span><br><span class="line">â€“service-cluster-ip-range Serviceè™šæ‹ŸIPåœ°å€æ®µ</span><br><span class="line">â€“enable-admission-plugins å‡†å…¥æ§åˆ¶æ¨¡å—</span><br><span class="line">â€“authorization-mode è®¤è¯æˆæƒï¼Œå¯ç”¨RBACæˆæƒå’ŒèŠ‚ç‚¹è‡ªç®¡ç†</span><br><span class="line">â€“enable-bootstrap-token-auth å¯ç”¨TLS bootstrapåŠŸèƒ½ï¼Œåé¢ä¼šè®²åˆ°</span><br><span class="line">â€“token-auth-file tokenæ–‡ä»¶</span><br><span class="line">â€“service-node-port-range Service Nodeç±»å‹é»˜è®¤åˆ†é…ç«¯å£èŒƒå›´</span><br></pre></td></tr></table></figure>

<p><font color="orange">systemdç®¡ç†apiserver</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /usr/lib/systemd/system/kube-apiserver.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-apiserver</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-apiserver $KUBE_APISERVER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><font color="orange">å¯åŠ¨</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> systemctl daemon-reload</span><br><span class="line"><span class="meta">#</span> systemctl enable kube-apiserver</span><br><span class="line"><span class="meta">#</span> systemctl restart kube-apiserver</span><br></pre></td></tr></table></figure>

<h4 id="éƒ¨ç½²schedulerç»„ä»¶"><a href="#éƒ¨ç½²schedulerç»„ä»¶" class="headerlink" title="éƒ¨ç½²schedulerç»„ä»¶"></a>éƒ¨ç½²schedulerç»„ä»¶</h4><p><font color="orange">åˆ›å»ºschedulerç»„ä»¶</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /opt/kubernetes/cfg/kube-scheduler </span><br><span class="line"></span><br><span class="line">KUBE_SCHEDULER_OPTS="--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--master=127.0.0.1:8080 \</span><br><span class="line">--leader-elect"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>---------------------------------------------------------------------------------</span><br><span class="line">å‚æ•°è¯´æ˜ï¼š</span><br><span class="line">â€“master è¿æ¥æœ¬åœ°apiserver</span><br><span class="line">â€“leader-elect å½“è¯¥ç»„ä»¶å¯åŠ¨å¤šä¸ªæ—¶ï¼Œè‡ªåŠ¨é€‰ä¸¾ï¼ˆHAï¼‰</span><br></pre></td></tr></table></figure>

<p><font color="orange">systemdç®¡ç†schedulerç»„ä»¶</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /usr/lib/systemd/system/kube-scheduler.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-scheduler</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-scheduler $KUBE_SCHEDULER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><font color="orange">å¯åŠ¨</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> systemctl daemon-reload</span><br><span class="line"><span class="meta">#</span> systemctl enable kube-scheduler</span><br><span class="line"><span class="meta">#</span> systemctl restart kube-scheduler</span><br></pre></td></tr></table></figure>

<h4 id="éƒ¨ç½²controller-managerç»„ä»¶"><a href="#éƒ¨ç½²controller-managerç»„ä»¶" class="headerlink" title="éƒ¨ç½²controller-managerç»„ä»¶"></a>éƒ¨ç½²controller-managerç»„ä»¶</h4><p><font color="orange">åˆ›å»ºcontroller-managerç»„ä»¶</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /opt/kubernetes/cfg/kube-controller-manager </span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS="--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--master=127.0.0.1:8080 \</span><br><span class="line">--leader-elect=true \</span><br><span class="line">--address=127.0.0.1 \</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \</span><br><span class="line">--cluster-name=kubernetes \</span><br><span class="line">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \</span><br><span class="line">--root-ca-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem"</span><br></pre></td></tr></table></figure>

<p><font color="orange">systemdç®¡ç†controller-managerç»„ä»¶</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /usr/lib/systemd/system/kube-controller-manager.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-controller-manager</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><font color="orange">å¯åŠ¨</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> systemctl daemon-reload</span><br><span class="line"><span class="meta">#</span> systemctl enable kube-controller-manager</span><br><span class="line"><span class="meta">#</span> systemctl restart kube-controller-manager</span><br></pre></td></tr></table></figure>

<p><strong>è‡³æ­¤ï¼Œæ‰€æœ‰ç»„ä»¶éƒ½å¯åŠ¨æˆåŠŸï¼Œé€šè¿‡kubectlå·¥å…·æŸ¥çœ‹å½“å‰é›†ç¾¤ç»„ä»¶çŠ¶æ€</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s_master1 k8s]# kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">etcd-2               Healthy   &#123;"health": "true"&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;"health": "true"&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;"health": "true"&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä¹ã€NodeèŠ‚ç‚¹éƒ¨ç½²ç»„ä»¶"><a href="#ä¹ã€NodeèŠ‚ç‚¹éƒ¨ç½²ç»„ä»¶" class="headerlink" title="ä¹ã€NodeèŠ‚ç‚¹éƒ¨ç½²ç»„ä»¶"></a>ä¹ã€NodeèŠ‚ç‚¹éƒ¨ç½²ç»„ä»¶</h3><p>Master apiserverå¯ç”¨TLSè®¤è¯åï¼ŒNodeèŠ‚ç‚¹kubeletç»„ä»¶æƒ³è¦åŠ å…¥é›†ç¾¤ï¼Œå¿…é¡»ä½¿ç”¨CAç­¾å‘çš„æœ‰æ•ˆè¯ä¹¦æ‰èƒ½ä¸apiserveré€šä¿¡ï¼Œå½“NodeèŠ‚ç‚¹å¾ˆå¤šæ—¶ï¼Œç­¾ç½²è¯ä¹¦æ˜¯ä¸€ä»¶å¾ˆç¹ççš„äº‹æƒ…ï¼Œå› æ­¤æœ‰äº†TLS Bootstrappingæœºåˆ¶ï¼Œkubeletä¼šä»¥ä¸€ä¸ªä½æƒé™ç”¨æˆ·è‡ªåŠ¨å‘apiserverç”³è¯·è¯ä¹¦ï¼Œkubeletçš„è¯ä¹¦ç”±apiserveråŠ¨æ€ç­¾ç½²ã€‚</p>
<h4 id="å°†kubelet-bootstrapç”¨æˆ·ç»‘å®šåˆ°ç³»ç»Ÿé›†ç¾¤è§’è‰²"><a href="#å°†kubelet-bootstrapç”¨æˆ·ç»‘å®šåˆ°ç³»ç»Ÿé›†ç¾¤è§’è‰²" class="headerlink" title="å°†kubelet-bootstrapç”¨æˆ·ç»‘å®šåˆ°ç³»ç»Ÿé›†ç¾¤è§’è‰²"></a>å°†kubelet-bootstrapç”¨æˆ·ç»‘å®šåˆ°ç³»ç»Ÿé›†ç¾¤è§’è‰²</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">  --clusterrole=system:node-bootstrapper \</span><br><span class="line">  --user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>

<h4 id="åˆ›å»ºkubeconfigæ–‡ä»¶"><a href="#åˆ›å»ºkubeconfigæ–‡ä»¶" class="headerlink" title="åˆ›å»ºkubeconfigæ–‡ä»¶"></a>åˆ›å»ºkubeconfigæ–‡ä»¶</h4><p><strong>åœ¨ç”Ÿæˆkubernetesè¯ä¹¦çš„ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆkubeconfigæ–‡ä»¶ï¼ˆ/home/k8sï¼‰ï¼Œåˆ›å»ºkubernetes.sh</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># åˆ›å»ºkubelet bootstrapping kubeconfig </span><br><span class="line">BOOTSTRAP_TOKEN=674c457d4dcf2eefe4920d7dbb6b0ddc</span><br><span class="line">KUBE_APISERVER=&quot;https://192.168.18.80:6443&quot;</span><br><span class="line"></span><br><span class="line"># è®¾ç½®é›†ç¾¤å‚æ•°</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=./ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span><br><span class="line">kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">  --token=$&#123;BOOTSTRAP_TOKEN&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubelet-bootstrap \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span><br><span class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">#-------------------------------------------------------------------</span><br><span class="line">#-------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºkube-proxy kubeconfigæ–‡ä»¶</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=./ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=./kube-proxy.pem \</span><br><span class="line">  --client-key=./kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p><font color="gree">åœ¨å†™å®Œä¸Šè¿°çš„shellè„šæœ¬åï¼Œæ‰§è¡Œchmod 777 kubernetes.shï¼Œæ‰§è¡Œ./kubernetes.sh</font></p>
<p>è¿™æ—¶å¯ä»¥å‘ç°ç”Ÿæˆäº†<strong>bootstrap.kubeconfig</strong>å’Œ<strong>kube-proxy.kubeconfig</strong>ä¸¤ä¸ªæ–‡ä»¶ï¼ˆå¦¥å–„ä¿å­˜ï¼Œä¸€æ—¦æ³„éœ²ï¼Œé›†ç¾¤ç‚¸äº†ï¼‰ï¼Œå°†è¿™ä¸¤ä¸ªæ–‡ä»¶é€šè¿‡scpå‘é€åˆ°æ‰€æœ‰<strong>NodeèŠ‚ç‚¹çš„/opt/kubernetes/cfg</strong>ç›®å½•ä¸‹ã€‚</p>
<p><font color="scarlet">è§£é‡Šä¸€ä¸‹ï¼ŒåŒæ³¨é‡Šä¹‹ä¸Šçš„ä»£ç ä¸»è¦æ˜¯ä¸ºäº†åœ¨nodeèŠ‚ç‚¹ä¸Šæ‰§è¡Œåœ¨masterèŠ‚ç‚¹ä¸Šçš„å‘½ä»¤ï¼Œéœ€è¦å°†masterèŠ‚ç‚¹ä¸Šçš„kubectlé€šè¿‡scpå‘é€åˆ°æ‰€æœ‰nodeçš„/opt/kubernetes/binä¸‹ï¼ŒåŒæ—¶ä¿®æ”¹<strong>/etc/profile</strong>æ–‡ä»¶ï¼Œæ·»åŠ ç¯å¢ƒå˜é‡<strong>export PATH=$PATH:/opt/kubernetes/bin/</strong>ï¼ŒåŒæ—¶nodeèŠ‚ç‚¹éœ€è¦cdåˆ°æ”¾æœ‰kubelet.kubeconfigçš„ç›®å½•ä¸‹æ‰§è¡Œ<strong>kubectl get nodes â€“kubeconfig=kubelet.kubeconfig</strong>å‘½ä»¤ã€‚</font></p>
<h4 id="éƒ¨ç½²kubeletç»„ä»¶"><a href="#éƒ¨ç½²kubeletç»„ä»¶" class="headerlink" title="éƒ¨ç½²kubeletç»„ä»¶"></a>éƒ¨ç½²kubeletç»„ä»¶</h4><p>è§£å‹<strong>kubernetes-server-linux-amd64.tar.gz</strong>åï¼Œåœ¨<strong>/kubernetes/server/bin</strong>ä¸‹æ‰¾åˆ°<strong>kubelet</strong>å’Œ<strong>kube-proxy</strong>ä¸¤ä¸ªæ–‡ä»¶ï¼Œå°†è¿™ä¸¤ä¸ªæ–‡ä»¶æ‹·è´åˆ°<strong>NodeèŠ‚ç‚¹çš„/opt/kubernetes/bin</strong>ç›®å½•ä¸‹ã€‚</p>
<p><font color="orange">åˆ›å»ºkubeleté…ç½®æ–‡ä»¶</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /opt/kubernetes/cfg/kubelet</span><br><span class="line">KUBELET_OPTS="--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--hostname-override=192.168.18.85 \</span><br><span class="line">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \</span><br><span class="line">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \</span><br><span class="line">--config=/opt/kubernetes/cfg/kubelet.config \</span><br><span class="line">--cert-dir=/opt/kubernetes/ssl \</span><br><span class="line">--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>----------------------------------------------------------------------------------</span><br><span class="line">å‚æ•°è¯´æ˜ï¼š</span><br><span class="line">â€“hostname-override åœ¨é›†ç¾¤ä¸­æ˜¾ç¤ºçš„ä¸»æœºå</span><br><span class="line">â€“kubeconfig æŒ‡å®škubeconfigæ–‡ä»¶ä½ç½®ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆ</span><br><span class="line">â€“bootstrap-kubeconfig æŒ‡å®šåˆšæ‰ç”Ÿæˆçš„bootstrap.kubeconfigæ–‡ä»¶</span><br><span class="line">â€“cert-dir é¢å‘è¯ä¹¦å­˜æ”¾ä½ç½®</span><br><span class="line">â€“pod-infra-container-image ç®¡ç†Podç½‘ç»œçš„é•œåƒ</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ç¬¬7è¡Œçš„kubelet.configé…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼Œä½ç½®ä½äº<strong>NodeèŠ‚ç‚¹çš„/opt/kubernetes/cfg/kubelet.config</strong>ä¸‹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">address:</span> <span class="number">192.168</span><span class="number">.18</span><span class="number">.85</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">10250</span></span><br><span class="line"><span class="attr">readOnlyPort:</span> <span class="number">10255</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">cgroupfs</span></span><br><span class="line"><span class="attr">clusterDNS:</span> <span class="string">["10.0.0.2"]</span></span><br><span class="line"><span class="attr">clusterDomain:</span> <span class="string">cluster.local.</span></span><br><span class="line"><span class="attr">failSwapOn:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">authentication:</span></span><br><span class="line"><span class="attr">  anonymous:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><font color="orange">systemdç®¡ç†kubeletç»„ä»¶</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /usr/lib/systemd/system/kubelet.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kubelet</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kubelet $KUBELET_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><font color="orange">å¯åŠ¨</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> systemctl daemon-reload</span><br><span class="line"><span class="meta">#</span> systemctl enable kubelet</span><br><span class="line"><span class="meta">#</span> systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<p><strong>ä¸Šè¿°æ“ä½œåœ¨æ‰€æœ‰NodeèŠ‚ç‚¹éƒ½è¦æ‰§è¡Œï¼Œåœ¨å¯åŠ¨åè¿˜æ˜¯æ²¡æœ‰åŠ å…¥åˆ°é›†ç¾¤ä¸­ï¼Œè¿™æ—¶éœ€è¦Masteræ‰‹åŠ¨å…è®¸æ‰å¯ä»¥ã€‚</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> kubectl get csr</span><br><span class="line"><span class="meta">#</span> kubectl certificate approve XXXXID</span><br><span class="line"><span class="meta">#</span> kubectl get node</span><br><span class="line"><span class="meta">#</span>-----------------------------------------------------------</span><br><span class="line">å¦‚ï¼škubectl get csr</span><br><span class="line">   kubectl certificate approve node-csr-PjBnNDUYsE1soevzLVunyjrCWDEOj_bMUo7ypVuQOXs</span><br></pre></td></tr></table></figure>

<h4 id="éƒ¨ç½²kube-proxyç»„ä»¶"><a href="#éƒ¨ç½²kube-proxyç»„ä»¶" class="headerlink" title="éƒ¨ç½²kube-proxyç»„ä»¶"></a>éƒ¨ç½²kube-proxyç»„ä»¶</h4><p><font color="orange">åˆ›å»ºkube-proxyé…ç½®æ–‡ä»¶</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /opt/kubernetes/cfg/kube-proxy</span><br><span class="line">KUBE_PROXY_OPTS="--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--hostname-override=192.168.18.85 \</span><br><span class="line">--cluster-cidr=10.0.0.0/24 \</span><br><span class="line">--kubeconfig=/opt/kubernetes/cfg/kube-proxy.kubeconfig"</span><br></pre></td></tr></table></figure>

<p><font color="orange">systemdç®¡ç†Kube-proxyç»„ä»¶</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> cat /usr/lib/systemd/system/kube-proxy.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-proxy</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-proxy $KUBE_PROXY_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p><font color="orange">å¯åŠ¨</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> systemctl daemon-reload</span><br><span class="line"><span class="meta">#</span> systemctl enable kube-proxy</span><br><span class="line"><span class="meta">#</span> systemctl restart kube-proxy</span><br></pre></td></tr></table></figure>

<p><strong>åŒæ ·çš„ï¼Œä¸Šè¿°æ“ä½œåœ¨æ¯ä¸ªNodeèŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ</strong></p>
<h4 id="æŸ¥çœ‹é›†ç¾¤çŠ¶æ€"><a href="#æŸ¥çœ‹é›†ç¾¤çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹é›†ç¾¤çŠ¶æ€"></a>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s_master1 bin]# kubectl get node</span><br><span class="line">NAME            STATUS   ROLES    AGE     VERSION</span><br><span class="line">192.168.18.85   Ready    &lt;none&gt;   3h52m   v1.12.1</span><br><span class="line">192.168.18.86   Ready    &lt;none&gt;   3h42m   v1.12.1</span><br><span class="line">[root@k8s_master1 bin]# kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">etcd-1               Healthy   &#123;"health": "true"&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;"health": "true"&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;"health": "true"&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åã€è¿è¡Œæµ‹è¯•"><a href="#åã€è¿è¡Œæµ‹è¯•" class="headerlink" title="åã€è¿è¡Œæµ‹è¯•"></a>åã€è¿è¡Œæµ‹è¯•</h3><p><font color="orange">åˆ›å»ºä¸€ä¸ªNginx Webï¼Œæµ‹è¯•é›†ç¾¤æ˜¯å¦æ­£å¸¸å·¥ä½œ</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> kubectl run nginx --image=nginx --replicas=3</span><br><span class="line"><span class="meta">#</span> kubectl expose deployment nginx --port=88 --target-port=80 --type=NodePort</span><br></pre></td></tr></table></figure>

<p><font color="orange">æŸ¥çœ‹podï¼Œservice</font></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s_master1 bin]# kubectl get pods</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-dbddb74b8-4cd2k   1/1     Running   0          110m</span><br><span class="line">nginx-dbddb74b8-css9h   1/1     Running   0          110m</span><br><span class="line">nginx-dbddb74b8-mbkdg   1/1     Running   0          110m</span><br><span class="line">[root@k8s_master1 bin]# kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes   ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP        6h44m</span><br><span class="line">nginx        NodePort    10.0.0.228   &lt;none&gt;        88:42959/TCP   110m</span><br></pre></td></tr></table></figure>

<p>åœ¨æœ¬åœ°æµè§ˆå™¨è¾“å…¥Nodeçš„ipåŠ ä¸ŠNginxçš„portï¼ˆå¦‚ï¼š42959ï¼‰ï¼Œåº”è¯¥ä¼šè®¿é—®åˆ°ã€‚</p>
<img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/k8s_test.png">



<h3 id="åä¸€ã€å®‰è£…kuboardå¯è§†åŒ–ç•Œé¢"><a href="#åä¸€ã€å®‰è£…kuboardå¯è§†åŒ–ç•Œé¢" class="headerlink" title="åä¸€ã€å®‰è£…kuboardå¯è§†åŒ–ç•Œé¢"></a>åä¸€ã€å®‰è£…kuboardå¯è§†åŒ–ç•Œé¢</h3><ul>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> å¯ä»¥åœ¨masterèŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</span><br><span class="line">kubectl apply -f https://kuboard.cn/install-script/kuboard.yaml</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> æŸ¥çœ‹kuboardè¿è¡ŒçŠ¶æ€</span><br><span class="line">[root@k8s_master1 ~]# kubectl get pods -l k8s.eip.work/name=kuboard -n kube-system</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kuboard-56b99986dc-9zsqg   1/1     Running   1          15h</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> è·å–Token,ç™»å½•ç•Œé¢éœ€è¦token</span><br><span class="line">[root@k8s_master1 ~]# kubectl -n kube-system get secret $(kubectl -n kube-system get secret | grep kuboard-user | awk '&#123;print $1&#125;') -o go-template='&#123;&#123;.data.token&#125;&#125;' | base64 -d</span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJvYXJkLXVzZXItdG9rZW4tOXQ5ZGIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoia3Vib2FyZC11c2VyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiMWJlMDUxMWItN2I3ZC0xMWVhLWIxMDUtMDAwYzI5YWVhZTQ1Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmt1Ym9hcmQtdXNlciJ9.WqqZGdn_rFBhNiJRYFOT088-afLI3m88IP0U4wJuEbYSwuUkhDodf67j76WpITnCdL5t_dsHJeKBHs9mAUHcUiZIqaCrnPXgsvh7sxi9IhD5CGFj1DqzstiGThGQmY7Su3w1SO-KrmInkfWwkaFIqLjvKUhjxzX4OoO_fJgdLdeUZOAF1gbNg_TC98IhZPFE-qlKTaL2u_5o1OxpzKVWx5z52G6eqeTZiprq39_rhpKQElU3IBLAyU6CtLsmxFF66kxgj9qPaYzpHV6U_Hsw0KtX3qEcNbC0GIxOEw4HFNDABzSUx4dATVWKfg9zeldz5gJB7AumZmmz63lfqFAOIw</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> æŸ¥çœ‹æš´éœ²çš„ç«¯å£32567</span><br><span class="line">[root@k8s_master1 ~]# kubectl get svc -n kube-system</span><br><span class="line">NAME      TYPE       CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kuboard   NodePort   10.0.0.41    &lt;none&gt;        80:32567/TCP   15h</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ä»»æ„ä¸€ä¸ªnodeèŠ‚ç‚¹ip:32567</span><br><span class="line"># http://192.168.18.85:32567</span><br></pre></td></tr></table></figure>

<p><strong>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</strong></p>
<img src="https://wzcwangzichen.oss-cn-shanghai.aliyuncs.com/Picture/kuboard.png">

</li>
</ul>
<p><font color="navy blue">è‡³æ­¤ï¼Œä¸€ä¸ªå•masterçš„Kubernetesé›†ç¾¤å·²ç»åˆ›å»ºæˆåŠŸäº†ï¼å¯èƒ½è¿˜æœ‰ä¸€äº›ç»„ä»¶æ²¡æœ‰å®‰è£…ï¼ˆcoreDnsç­‰ç­‰ï¼‰</font></p>
<hr>
<h4 id="æ€»ç»“æš‚æ—¶å‡ºç°çš„é—®é¢˜"><a href="#æ€»ç»“æš‚æ—¶å‡ºç°çš„é—®é¢˜" class="headerlink" title="æ€»ç»“æš‚æ—¶å‡ºç°çš„é—®é¢˜"></a>æ€»ç»“æš‚æ—¶å‡ºç°çš„é—®é¢˜</h4><ul>
<li><p>éƒ¨ç½²kubectl run nginx â€“image=nginx â€“replicas=3å’Œkubectl expose deployment nginx â€“port=88 â€“target-port=80 â€“type=NodePortæ—¶ï¼Œkubectl get podsæ€»æ˜¯<strong>ContainerCreating</strong>ï¼Œä¸€ç›´æ²¡æœ‰å‡ºç°Runningï¼Œä¹‹åé€šè¿‡<strong>kubectl describe pod nginx</strong>æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼Œåœ¨Eventçš„é‚£ä¸€è¡Œæœ‰ä¸ª<strong>warningï¼šshim error: docker-runc not installed on system</strong>ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ç¬¬ä¸€ç§æ–¹æ³•ï¼šä¿®æ”¹/etc/docker/daemon.jsonæ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "log-level":</span><span class="string">"warn"</span><span class="string">,</span></span><br><span class="line"><span class="attr">    "runtimes":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">        "docker-runc":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">            "path":</span> <span class="string">"/usr/libexec/docker/docker-runc-current"</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">    "add-runtime":</span> <span class="string">"docker-runc=/usr/libexec/docker/docker-runc-current"</span><span class="string">,</span></span><br><span class="line"><span class="attr">    "default-runtime":</span> <span class="string">"docker-runc"</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>ç¬¬äºŒç§æ–¹æ³•</span><br><span class="line">cd /usr/libexec/docker/</span><br><span class="line">sudo ln -s docker-runc-current docker-runc</span><br></pre></td></tr></table></figure>
</li>
<li><p>è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œæœ‰çš„æ—¶å€™systemctl restart dockeræ€»æ˜¯æœ‰é—®é¢˜ï¼Œæˆ‘ä¼šå°†dockerå®Œå…¨å¸è½½ï¼Œå†é‡æ–°å®‰è£…ä¸€æ¬¡ï¼Œæ³¨æ„ï¼Œé‡æ–°å®‰è£…è¦ä¿®æ”¹/usr/lib/systemd/system/docker.serviceè¿™ä¸ªæ–‡ä»¶ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>#dockerå¸è½½å®‰è£…</span><br><span class="line"><span class="meta">#</span>1ã€å…ˆæŸ¥è¯¢ä¸‹docker</span><br><span class="line">yum list installed | grep docker</span><br><span class="line"><span class="meta">#</span>2ã€æ‰§è¡Œå¸è½½å‘½ä»¤</span><br><span class="line">yum -y remove docker.x86_64 docker-client.x86_64</span><br><span class="line"><span class="meta">#</span>3ã€æ‰§è¡Œåˆ é™¤å·²å­˜åœ¨çš„é•œåƒå’Œå®¹å™¨</span><br><span class="line">rm -rf /var/lib/docker/</span><br><span class="line"><span class="meta">#</span>4ã€é‡æ–°å®‰è£…docker</span><br><span class="line">yum install -y docker</span><br></pre></td></tr></table></figure>

</li>
</ul>
<hr>
<h3 id="è¡¥å……ï¼šk8sä½¿ç”¨å…¥é—¨"><a href="#è¡¥å……ï¼šk8sä½¿ç”¨å…¥é—¨" class="headerlink" title="è¡¥å……ï¼šk8sä½¿ç”¨å…¥é—¨"></a>è¡¥å……ï¼šk8sä½¿ç”¨å…¥é—¨</h3><ul>
<li><strong>deploymentï¼š</strong>1ã€åˆ›å»ºæŒ‡å®šæ•°é‡çš„pod               2ã€æ£€æŸ¥podå¥åº·çŠ¶æ€å’Œæ•°é‡<ul>
<li>åŸºäºdeploymentåˆ›å»ºnginx podï¼Œæœ‰ä¸€ä¸ªå‰¯æœ¬<ul>
<li>æ–¹æ³•ä¸€ã€<code>[root@k8s_master1 ~]# kubectl run nginx-dep1 --image=nginx:1.8 --replicas=1</code></li>
<li>æ–¹æ³•äºŒã€<code>é€šè¿‡Kuboardæ¥åˆ›å»º</code></li>
<li>æ–¹æ³•ä¸‰ã€<code>é€šè¿‡yamlæ–‡ä»¶æ¥åˆ›å»º</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@k8s_master1</span> <span class="string">yaml]#</span> <span class="string">cat</span> <span class="string">nginx-dep.yaml</span> </span><br><span class="line"><span class="comment">#æ‰§è¡Œapiç‰ˆæœ¬ä¿¡æ¯</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ç±»å‹</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å…ƒæ•°æ®(deploymentçš„æ ‡ç­¾)</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ngx-dep</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">webservice</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å‰¯æœ¬|é€‰æ‹©å™¨</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span> </span><br><span class="line"><span class="attr">        app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">        type:</span> <span class="string">webservice</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">nginx:1.8</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@k8s_master1</span> <span class="string">yaml]#</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="bullet">-f</span> <span class="string">nginx-dep.yaml</span> </span><br><span class="line"><span class="string">deployment.apps/ngx-dep</span> <span class="string">created</span></span><br><span class="line"><span class="string">[root@k8s_master1</span> <span class="string">yaml]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span></span><br><span class="line"><span class="string">NAME</span>                       <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">ngx-dep-5ccc65dd98-mdpsz</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="string">[root@k8s_master1</span> <span class="string">yaml]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="bullet">-o</span> <span class="string">wide</span></span><br><span class="line"><span class="string">NAME</span>                       <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>     <span class="string">IP</span>            <span class="string">NODE</span>            <span class="string">NOMINATED</span> <span class="string">NODE</span></span><br><span class="line"><span class="string">ngx-dep-5ccc65dd98-mdpsz</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">3</span><span class="string">m30s</span>   <span class="number">172.17</span><span class="number">.76</span><span class="number">.2</span>   <span class="number">192.168</span><span class="number">.18</span><span class="number">.85</span>   <span class="string">&lt;none&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>æŸ¥çœ‹k8så¯¹è±¡çŠ¶æ€</p>
<ul>
<li>kubctl get èµ„æºç±»å‹<ul>
<li>èµ„æºç±»å‹ï¼šnodeï¼Œpodï¼Œserviceï¼Œdeploymentï¼Œnamespaceâ€¦</li>
<li>é€‰é¡¹ï¼š-n namespaceæˆ–è€…-Aç­‰ç­‰ï¼ˆæŒ‡å®šå‘½åç©ºé—´kubectl get pods â€“namespace=developmentï¼‰</li>
<li>ä¾‹ï¼šæ˜¾ç¤ºæ‰€æœ‰åç§°ç©ºé—´ä¸­çš„podï¼ˆ<code>kubectl get pod -A -o wide</code>ï¼‰</li>
</ul>
</li>
<li>kubectl describe èµ„æºç±»å‹<ul>
<li><code>kubectl describe pod ngx-dep-5ccc65dd98-mdpsz</code></li>
<li><code>kubectl describe node k8s_node1</code></li>
<li><code>kubectl logs pod ngx-dep-5ccc65dd98-mdpsz</code></li>
<li>ç™»å½•å®¹å™¨<code>kubectl exec -it ngx-dep-5ccc65dd98-mdpsz /bin/bash</code></li>
</ul>
</li>
</ul>
</li>
<li><p>å‘å¸ƒåº”ç”¨</p>
<ul>
<li>ç”¨serviceæ¥å‘å¸ƒæœåŠ¡ï¼ˆåˆ›å»ºyamlå¹¶æ‰§è¡Œï¼‰</li>
</ul>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ngx-svc</span></span><br><span class="line"><span class="attr">  labels:</span> </span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  ports:</span> </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">nginx-ports</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    nodePort:</span> <span class="number">32123</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">#ç­‰åŒäºkubectl expose deployment nginx --port=80 --target-port=80 --type=NodePort</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>æœåŠ¡ä¼¸ç¼©ï¼ˆScallingï¼‰å¼¹æ€§ç®¡ç†</p>
<ul>
<li>å³ä¿®æ”¹å‰¯æœ¬çš„æ•°é‡replicas</li>
</ul>
</li>
<li><p>æ»šåŠ¨æ›´æ–°</p>
<ul>
<li>ä¾‹ï¼šè‹¥æ˜¯å°†3ä¸ªnginx:1.7æ›´æ–°æˆnginx:1.8ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª1.8æ¥æ›¿æ¢ä¸€ä¸ª1.7ï¼Œé‡å¤æ“ä½œ</li>
<li>ä¿®æ”¹yamlçš„imageçš„ä¿¡æ¯</li>
</ul>
</li>
<li><p>k8sé€šç”¨è¿ç§»æµç¨‹</p>
<ul>
<li>åˆ¶ä½œé•œåƒ</li>
<li>å°†é•œåƒå¯åŠ¨ä¸ºpod</li>
<li>æš´éœ²åº”ç”¨ï¼ˆå†…éƒ¨ï¼‰</li>
<li>å¯¹å¤–å‘å¸ƒåº”ç”¨</li>
<li>ç›‘æ§/æ—¥å¿—</li>
</ul>
</li>
<li><p>é•œåƒç±»åˆ«</p>
<ul>
<li>é•œåƒä½œç”¨ï¼šä¸€ä¸ªé•œåƒä¸­è¿è¡Œä¸€ä¸ªæœåŠ¡</li>
<li>ä¸‰ç±»é•œåƒï¼š<ul>
<li>åŸºç¡€é•œåƒï¼ˆçº¯å‡€ç‰ˆcentosç³»ç»Ÿç­‰ç­‰ï¼‰</li>
<li>è¿è¡Œç¯å¢ƒé•œåƒï¼ˆåŠ å…¥jdkï¼Œmysqlï¼Œphpï¼‰</li>
<li>é¡¹ç›®é•œåƒï¼ˆåŠ å…¥é¡¹ç›®ä»£ç ï¼‰</li>
</ul>
</li>
</ul>
</li>
</ul>

      
      <!-- reward -->
      
      <div id="reward-btn">
        æ‰“èµ
      </div>
      
    </div>
    
    
      <!-- copyright -->
      
        <div class="declare">
          <ul class="post-copyright">
            <li>
              <i class="ri-copyright-line"></i>
              <strong>ç‰ˆæƒå£°æ˜ï¼š </strong s>
              æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://www.apache.org/licenses/LICENSE-2.0.html" rel="external nofollow"
                target="_blank">Apache License 2.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
            </li>
          </ul>
        </div>
        
    <footer class="article-footer">
      
          
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        åˆ†äº«
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://www.codedog.fun/2020/04/12/Kubernetes(k8s)ä¸ªäººç¬”è®°(æ›´æ–°ä¸­)/" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
    </div>
</div>

<div id="share-mask"></div>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li></ul>


    </footer>

  </div>

  
  
  <nav class="article-nav">
    
      <a href="/2020/04/13/4-13/" class="article-nav-link">
        <strong class="article-nav-caption">ä¸Šä¸€ç¯‡</strong>
        <div class="article-nav-title">
          
            è®¾è®¡æ¨ç‰¹
          
        </div>
      </a>
    
    
      <a href="/2020/04/12/4-12/" class="article-nav-link">
        <strong class="article-nav-caption">ä¸‹ä¸€ç¯‡</strong>
        <div class="article-nav-title">äº¤ç‚¹</div>
      </a>
    
  </nav>


  

  
  
<!-- valineè¯„è®º -->
<div id="vcomments-box">
    <div id="vcomments">
    </div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: '1yf8gY1YRw7AbvWoiPFYoY3x-gzGzoHsz',
        app_key: '0W6HVhxWDB0tDqkv2z0ta0S7',
        path: window.location.pathname,
        notify: 'true',
        verify: 'true',
        avatar: 'mp',
        placeholder: 'ç»™æˆ‘çš„æ–‡ç« åŠ ç‚¹è¯„è®ºå§~',
        recordIP: true
    });
    const infoEle = document.querySelector('#vcomments .info');
    if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
        infoEle.childNodes.forEach(function (item) {
            item.parentNode.removeChild(item);
        });
    }
</script>
<style>
    #vcomments-box {
        padding: 5px 30px;
    }

    @media screen and (max-width: 800px) {
        #vcomments-box {
            padding: 5px 0px;
        }
    }

    #vcomments-box #vcomments {
        background-color: #fff;
    }

    .v .vlist .vcard .vh {
        padding-right: 20px;
    }

    .v .vlist .vcard {
        padding-left: 10px;
    }
</style>

  

  
  
  

</article>
</section>
      <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>
        &copy;
        2019-2020
        WangZiChen
      </li>
      <li>
        
      </li>
    </ul>
    <ul class="list-inline">
      <li>
        
        
        <span>
  <i>PV:<span id="busuanzi_value_page_pv"></span></i>
  <i>UV:<span id="busuanzi_value_site_uv"></span></i>
</span>
        
      </li>
      
      <li>
        <a href="http://www.beian.miit.gov.cn/" target="_black">è‹ICPå¤‡19019208å·</a>
      </li>
      
      <li>
        <!-- cnzzç»Ÿè®¡ -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>
      <div class="to_top">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>
      </div>
    </main>
    <aside class="sidebar">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/delisha.jpg" alt="wangzichençš„ä¸ªäººåšå®¢"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">ä¸»é¡µ</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">å½’æ¡£</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">åˆ†ç±»</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">æ ‡ç­¾</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/favourite">æ”¶è—</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/photos">å£çº¸</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">å…³äºæˆ‘</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>è¯·æˆ‘å–æ¯å’–å•¡å§~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/ZFB.jpg">
      <span class="reward-type">æ”¯ä»˜å®</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/WX.jpg">
      <span class="reward-type">å¾®ä¿¡</span>
    </div>
    
  </div>
</div>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/share.js"></script>
<script src="/js/lazyload.min.js"></script>

<script>
  try {
    var typed = new Typed("#subtitle", {
      strings: ['å¥½å¥½å­¦ä¹ ,å¤©å¤©å‘ä¸Š', 'æ¯å¤©åšæŒä¸€ç‚¹ç‚¹', ''],
      startDelay: 0,
      typeSpeed: 180,
      loop: true,
      backSpeed: 180,
      showCursor: false
    });
  } catch (err) {
  }

</script>



<script src="/js/tocbot.min.js"></script>
<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
    onClick: (e) => {
      $('.toc-link').removeClass('is-active-link');
      $(`a[href=${e.target.hash}]`).addClass('is-active-link');
      $(e.target.hash).scrollIntoView();
      return false;
    }
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/ayer.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // sliderå±•å¼€çŠ¶æ€
                // todo: è¿™æ ·ä¸å¥½ï¼Œåé¢æ”¹æˆçŠ¶æ€
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // è·å¾—åŸå›¾å°ºå¯¸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
  var ayerConfig = {
    mathjax: true
  }
</script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>


<script type="text/javascript" src="https://js.users.51.la/20544303.js"></script>

    
  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-wanko"},"display":{"position":"left","width":75,"height":100},"mobile":{"show":true},"log":false});</script></body>

</html>